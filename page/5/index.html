<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/BlogPro/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/BlogPro/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/BlogPro/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/BlogPro/images/logo.svg" color="#222">

<link rel="stylesheet" href="/BlogPro/css/main.css">


<link rel="stylesheet" href="/BlogPro/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/BlogPro/lib/pace/pace-theme-minimal.min.css">
  <script src="/BlogPro/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"smdegz.github.io","root":"/BlogPro/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
<meta property="og:type" content="website">
<meta property="og:title" content="何锦祥 博客">
<meta property="og:url" content="https://smdegz.github.io/BlogPro/page/5/index.html">
<meta property="og:site_name" content="何锦祥 博客">
<meta property="og:description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="生活, 思考, 感悟, 分享">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://smdegz.github.io/BlogPro/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>何锦祥 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/SMDegz" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/BlogPro/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">何锦祥 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">你知道的越多 你不知道的也就越多</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/BlogPro/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/BlogPro/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/BlogPro/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/BlogPro/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/BlogPro/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/5%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83nacos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/5%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83nacos/" class="post-title-link" itemprop="url">5、微服务-配置中心nacos</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-05 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-05T10:48:57+08:00">2023-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-30 23:33:44" itemprop="dateModified" datetime="2024-01-30T23:33:44+08:00">2024-01-30</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/5%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83nacos/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/5%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83nacos/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="4、微服务-配置中心nacos"><a href="#4、微服务-配置中心nacos" class="headerlink" title="4、微服务-配置中心nacos"></a>4、微服务-配置中心nacos</h1><h2 id="1、配置中心"><a href="#1、配置中心" class="headerlink" title="1、配置中心"></a>1、配置中心</h2><blockquote>
<p>配置中心：管理所有微服务的配置</p>
</blockquote>
<pre><code>例如：微服务配置appsetting.json：直接给配置中心管理
</code></pre>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-47.png" alt="Alt text"></p>
<h2 id="2、配置中心应用场景"><a href="#2、配置中心应用场景" class="headerlink" title="2、配置中心应用场景"></a>2、配置中心应用场景</h2><h3 id="2-1、电商微服务系统"><a href="#2-1、电商微服务系统" class="headerlink" title="2.1、电商微服务系统"></a>2.1、电商微服务系统</h3><p>​ 如图所示：<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-48.png" alt="Alt text"></p>
<p>查询商品业务场景</p>
<ul>
<li>实现流程：</li>
</ul>
<blockquote>
<p>客户端——电商网站—–API网关—–商品微服务——商品数据库</p>
</blockquote>
<h3 id="2-2、电商微服务系统配置"><a href="#2-2、电商微服务系统配置" class="headerlink" title="2.2、电商微服务系统配置"></a>2.2、电商微服务系统配置</h3><p>架构图如下：</p>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-49.png" alt="Alt text"></p>
<blockquote>
<p>问题：当维护电商微服务系统中的每一个appsetting.json配置文件时，如果微服务数量增多，微服务实例也变多，就会导致appsetting.json文件增多，增大维护量。导致维护效率下降。为了解决维护效率下降问题。</p>
</blockquote>
<ul>
<li>方案：配置中心</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-50.png" alt="Alt text"></p>
<blockquote>
<p>思路：将电商微服务系统中所有appsetting.json配置文件都交给配置中心管理，由配置中心统一维护，将原本分散的配置，做成集中配置，从而提升配置文件维护效率。</p>
</blockquote>
<blockquote>
<p>总结：以上是电商系统微服务系统中，使用配置中心的应用场景。</p>
</blockquote>
<blockquote>
<p>好处：配置中心，将分散的配置管理做成集中的配置管理，提升了配置文件维护效率，电商微服务系统更加专注业务开发。</p>
</blockquote>
<h2 id="3、配置中心技术选项"><a href="#3、配置中心技术选项" class="headerlink" title="3、配置中心技术选项"></a>3、配置中心技术选项</h2><ul>
<li>配置中心技术：</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-51.png" alt="Alt text"></p>
<pre><code>1、spring cloud config 使用麻烦

2、appollo 使用麻烦

3、nacos 可以满足

4、consul 功能少。
</code></pre>
<blockquote>
<p>根据技术4个特点来进行选型。</p>
</blockquote>
<pre><code>1、功能多

2、稳定强

3、性能高

4、使用简单
</code></pre>
<blockquote>
<p>4个方面进行技术选型</p>
</blockquote>
<h2 id="4、配置中心落地"><a href="#4、配置中心落地" class="headerlink" title="4、配置中心落地"></a>4、配置中心落地</h2><blockquote>
<p>含义：商品微服务appsettings.json配置文件交给配置中心管理<br>技术：nacos，nacos-sdk-csharp.Extensions.Configuration</p>
</blockquote>
<h3 id="4-1、Jdk准备"><a href="#4-1、Jdk准备" class="headerlink" title="4.1、Jdk准备"></a>4.1、Jdk准备</h3><blockquote>
<p>nacos是基于java开发，运行nacos之前，需要先安装jdk。</p>
</blockquote>
<ul>
<li><p>1、下载jdk</p>
<p>  地址：<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/downloads/#java8">https://www.oracle.com/java/technologies/downloads/#java8</a></p>
</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-52.png" alt="Alt text"></p>
<ul>
<li>2、安装jdk</li>
</ul>
<blockquote>
<p>双击安装，然后添加到环境变量</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-53.png" alt="Alt text"></p>
<h3 id="4-2、配置中心准备"><a href="#4-2、配置中心准备" class="headerlink" title="4.2、配置中心准备"></a>4.2、配置中心准备</h3><ul>
<li><p>1、下载nacos</p>
<p>  地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p>
</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-54.png" alt="Alt text"></p>
<ul>
<li>2、启动nacos</li>
</ul>
<blockquote>
<p>windows10 上直接启动，切换到F:\work.net_software\nacos\bin目录中。使用CMD，输入以下命令。然后直接启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup.cmd -m standalone</span><br></pre></td></tr></table></figure>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-55.png" alt="Alt text"></p>
<ul>
<li>3、访问nacos</li>
</ul>
<blockquote>
<p>浏览器中访问nacos</p>
</blockquote>
<pre><code>地址：http://localhost:8848/nacos/#/login
</code></pre>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-56.png" alt="Alt text"></p>
<p>用户名：nacos</p>
<p>密码：nacos</p>
<h3 id="4-2、商品微服务准备"><a href="#4-2、商品微服务准备" class="headerlink" title="4.2、商品微服务准备"></a>4.2、商品微服务准备</h3><ul>
<li>1、安装nacos-sdk-csharp.Extensions.Configuration</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中使用nuget安装nacos-sdk-csharp.Extensions.Configuration</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-57.png" alt="Alt text"></p>
<ul>
<li>2、使用nacos</li>
</ul>
<blockquote>
<p>含义：商品微服务地址appsettings.json给nacos</p>
</blockquote>
<ul>
<li>3、创建appsettings.json</li>
</ul>
<blockquote>
<p>在nacos后台管理首页中进行创建appsettings.json</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-58.png" alt="Alt text"></p>
<ul>
<li>配置appsettings.json</li>
</ul>
<blockquote>
<p>在appsettings.json添加内容，从YDT_ProductService项目中的appsettings.json文件中复制过来。</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-59.png" alt="Alt text"></p>
<ul>
<li>4、配置appsettings.json</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中配置appsettings.json</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  &quot;Nacos&quot;: &#123;</span><br><span class="line">      &quot;Namespace&quot;: &quot;&quot;, // 默认就可以</span><br><span class="line">      &quot;ServerAddresses&quot;: [ &quot;http://localhost:8848/&quot; ],</span><br><span class="line">      &quot;UserName&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;Password&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;AccessKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;SecretKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;ConfigUseRpc&quot;: false,</span><br><span class="line">      &quot;NamingUseRpc&quot;: false,</span><br><span class="line">      &quot;Listeners&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Optional&quot;: false,</span><br><span class="line">          &quot;DataId&quot;: &quot;appsettings.json&quot;,</span><br><span class="line">          &quot;Group&quot;: &quot;productservice&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置解析</p>
</blockquote>
<pre><code>ServerAddresses：nacos地址
UserName：nacos用户名
Password：nacos用户密码
Listeners：nacos订阅,订阅nacos中的配置文件
</code></pre>
<ul>
<li>5、加载Nacos配置</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中Program类中加载Nacos配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">using YDT_ProductService.Data;</span><br><span class="line">using Serilog;</span><br><span class="line">using Serilog.Events;</span><br><span class="line">using Volo.Abp.Data;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService;</span><br><span class="line"></span><br><span class="line">public class Program</span><br><span class="line">&#123;</span><br><span class="line">    public async static Task&lt;int&gt; Main(string[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        var loggerConfiguration = new LoggerConfiguration()</span><br><span class="line">#if DEBUG</span><br><span class="line">            .MinimumLevel.Debug()</span><br><span class="line">#else</span><br><span class="line">            .MinimumLevel.Information()</span><br><span class="line">#endif</span><br><span class="line">            .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Information)</span><br><span class="line">            .MinimumLevel.Override(&quot;Microsoft.EntityFrameworkCore&quot;, LogEventLevel.Warning)</span><br><span class="line">            .Enrich.FromLogContext()</span><br><span class="line">            .WriteTo.Async(c =&gt; c.File(&quot;Logs/logs.txt&quot;))</span><br><span class="line">            .WriteTo.Async(c =&gt; c.Console());</span><br><span class="line"></span><br><span class="line">        if (IsMigrateDatabase(args))</span><br><span class="line">        &#123;</span><br><span class="line">            loggerConfiguration.MinimumLevel.Override(&quot;Volo.Abp&quot;, LogEventLevel.Warning);</span><br><span class="line">            loggerConfiguration.MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Warning);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.Logger = loggerConfiguration.CreateLogger();</span><br><span class="line"></span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            var builder = WebApplication.CreateBuilder(args);</span><br><span class="line">            builder.Host.AddAppSettingsSecretsJson()</span><br><span class="line">                .UseAutofac()</span><br><span class="line">                .UseSerilog();</span><br><span class="line">            if (IsMigrateDatabase(args))</span><br><span class="line">            &#123;</span><br><span class="line">                builder.Services.AddDataMigrationEnvironment();</span><br><span class="line">            &#125;</span><br><span class="line">            await builder.AddApplicationAsync&lt;YDT_ProductServiceModule&gt;();</span><br><span class="line"></span><br><span class="line">            // 1、加载Nacos配置</span><br><span class="line">            var configuration = builder.Configuration;</span><br><span class="line">            configuration.AddNacosV2Configuration(configuration.GetSection(&quot;Nacos&quot;));// 加载Nacos配置。</span><br><span class="line"></span><br><span class="line">            var app = builder.Build();</span><br><span class="line">            await app.InitializeApplicationAsync();</span><br><span class="line"></span><br><span class="line">            Log.Information(&quot;Starting YDT_ProductService.&quot;);</span><br><span class="line">            await app.RunAsync();</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            if (ex is HostAbortedException)</span><br><span class="line">            &#123;</span><br><span class="line">                throw;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.Fatal(ex, &quot;YDT_ProductService terminated unexpectedly!&quot;);</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        finally</span><br><span class="line">        &#123;</span><br><span class="line">            Log.CloseAndFlush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static bool IsMigrateDatabase(string[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        return args.Any(x =&gt; x.Contains(&quot;--migrate-database&quot;, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>6、使用Nacos</li>
</ul>
<blockquote>
<p>含义：在YDT_ProductService项目中的使用Nacos中配置文件<br>技术：IConfiguration<br>流程：在YDT_ProductService项目ProductController类中通过IConfiguration使用Nacos</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line">using YDTProductService.Migrations;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 商品控制器</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;api/app/product&quot;)]</span><br><span class="line">public class ProductController : AbpController, IProductService</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IProductService</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IConfiguration</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IConfiguration Configuration &#123; get; set; &#125;   </span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 添加商品方法</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpPost(&quot;AddProduct&quot;)]</span><br><span class="line">    public async Task&lt;ProductDto&gt; AddProduct(ProductDto productDto)</span><br><span class="line">    &#123;</span><br><span class="line">       // 1、实现添加商品</span><br><span class="line">       return await productService.CreateAsync(productDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPost]</span><br><span class="line">    public Task&lt;ProductDto&gt; CreateAsync(ProductDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpDelete]</span><br><span class="line">    public Task DeleteAsync(Guid id)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet(&quot;id&quot;)]</span><br><span class="line">    public Task&lt;ProductDto&gt; GetAsync(Guid id)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet]</span><br><span class="line">    public Task&lt;PagedResultDto&lt;ProductDto&gt;&gt; GetListAsync(PagedAndSortedResultRequestDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*/// &lt;summary&gt;</span><br><span class="line">    /// 1、查询商品列表</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet(&quot;GetProducts&quot;)]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProducts()</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、实现添加商品</span><br><span class="line">        return  productService.GetListAsync(new PagedAndSortedResultRequestDto())</span><br><span class="line">            .Result.Items.ToList();</span><br><span class="line">    &#125;*/</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 1、查询商品列表</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet(&quot;GetProducts&quot;)]</span><br><span class="line">    public async Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        await Console.Out.WriteLineAsync(&quot;查询商品&quot;);</span><br><span class="line"></span><br><span class="line">        // 2、查询Nacos配置文件中的内容</span><br><span class="line">        string tony = Configuration[&quot;tony&quot;];</span><br><span class="line">        // 2.1、获取appsettings.json中内容</span><br><span class="line">        string redis = Configuration[&quot;redis:config&quot;];</span><br><span class="line"></span><br><span class="line">        // 2.2、获取app.json中内容</span><br><span class="line">        string app = Configuration[&quot;app&quot;];</span><br><span class="line"></span><br><span class="line">        // 2.3、获取package.json中内容</span><br><span class="line">        string version = Configuration[&quot;version&quot;];</span><br><span class="line"></span><br><span class="line">        // 1、实现查询商品</span><br><span class="line">        return productService.GetListAsync(new PagedAndSortedResultRequestDto())</span><br><span class="line">            .Result.Items.ToList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPut]</span><br><span class="line">    public Task&lt;ProductDto&gt; UpdateAsync(Guid id, ProductDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>7、启动商品微服务</li>
</ul>
<blockquote>
<p>进入YDT_ProductService项目目录中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>

<h2 id="5、配置中心-单服务多配置落地"><a href="#5、配置中心-单服务多配置落地" class="headerlink" title="5、配置中心-单服务多配置落地"></a>5、配置中心-单服务多配置落地</h2><blockquote>
<p>含义：微服务中有多个配置文件，都交给Nacos管理。<br>例如：商品微服务有多个配置文件，有appsettings.json、app.json、package.json等多个配置文件，统一交给nacos管理</p>
</blockquote>
<blockquote>
<p>技术：nacos-sdk-csharp.Extensions.Configuration</p>
</blockquote>
<ul>
<li>1、创建appsettings.json、app.json、package.json</li>
</ul>
<blockquote>
<p>在nacos后台管理首页中创建appsettings.json、app.json、package.json</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-60.png" alt="Alt text"></p>
<blockquote>
<p>配置appsettings.json、app.json、package.json<br>在appsettings.json配置内容，从YDT_ProductService项目中的appsettings.json、app.json、package.json文件中复制过来。</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-61.png" alt="Alt text"></p>
<ul>
<li>3、配置appsettings.json</li>
</ul>
<p>​&gt; 在YDT_ProductService项目中配置appsettings.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  &quot;Nacos&quot;: &#123;</span><br><span class="line">      &quot;Namespace&quot;: &quot;&quot;, // 默认就可以</span><br><span class="line">      &quot;ServerAddresses&quot;: [ &quot;http://localhost:8848/&quot; ],</span><br><span class="line">      &quot;UserName&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;Password&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;AccessKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;SecretKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;ConfigUseRpc&quot;: false,</span><br><span class="line">      &quot;NamingUseRpc&quot;: false,</span><br><span class="line">      &quot;Listeners&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Optional&quot;: false,</span><br><span class="line">          &quot;DataId&quot;: &quot;appsettings.json&quot;,</span><br><span class="line">          &quot;Group&quot;: &quot;productservice&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Optional&quot;: false,</span><br><span class="line">          &quot;DataId&quot;: &quot;app.json&quot;,</span><br><span class="line">          &quot;Group&quot;: &quot;productservice&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Optional&quot;: false,</span><br><span class="line">          &quot;DataId&quot;: &quot;package.json&quot;,</span><br><span class="line">          &quot;Group&quot;: &quot;productservice&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6、配置中心-多服务多配置落地"><a href="#6、配置中心-多服务多配置落地" class="headerlink" title="6、配置中心-多服务多配置落地"></a>6、配置中心-多服务多配置落地</h2><blockquote>
<p>含义：电商网站中配置文件交给nacos管理<br>例如：电商网站中有多个配置文件，有appsettings.json等配置文件，统一交给nacos管理</p>
</blockquote>
<blockquote>
<p>技术：nacos-sdk-csharp.Extensions.Configuratio</p>
</blockquote>
<h3 id="6-1、电商网站准备"><a href="#6-1、电商网站准备" class="headerlink" title="6.1、电商网站准备"></a>6.1、电商网站准备</h3><ul>
<li>1、安装nacos-sdk-csharp.Extensions.Configuration</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中使用nuget安装nacos-sdk-csharp.Extensions.Configuration</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-62.png" alt="Alt text"></p>
<ul>
<li>2、使用nacos</li>
</ul>
<blockquote>
<p>含义：电商网站appsettings.json配置文件给nacos</p>
</blockquote>
<ul>
<li>3、创建appsettings.json</li>
</ul>
<blockquote>
<p>在nacos后台管理首页中进行创建appsettings.json</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-63.png" alt="Alt text"><br>配置appsettings.json</p>
<blockquote>
<p>在appsettings.json添加内容，从YDT_WebSites项目中的appsettings.json文件中复制过来。</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-64.png" alt="Alt text"></p>
<ul>
<li>3、配置appsettings.json</li>
</ul>
<p>​&gt; 在YDT_WebSites项目中配置appsettings.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  &quot;Nacos&quot;: &#123;</span><br><span class="line">      &quot;Namespace&quot;: &quot;&quot;, // 默认就可以</span><br><span class="line">      &quot;ServerAddresses&quot;: [ &quot;http://localhost:8848/&quot; ],</span><br><span class="line">      &quot;UserName&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;Password&quot;: &quot;nacos&quot;,</span><br><span class="line">      &quot;AccessKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;SecretKey&quot;: &quot;&quot;,</span><br><span class="line">      &quot;ConfigUseRpc&quot;: false,</span><br><span class="line">      &quot;NamingUseRpc&quot;: false,</span><br><span class="line">      &quot;Listeners&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Optional&quot;: false,</span><br><span class="line">          &quot;DataId&quot;: &quot;appsettings.json&quot;,</span><br><span class="line">          &quot;Group&quot;: &quot;website&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置解析</p>
</blockquote>
<pre><code>ServerAddresses：nacos地址
UserName：nacos用户名
Password：nacos用户密码
Listeners：nacos订阅,订阅nacos中的配置文件appsettings.json和website
</code></pre>
<h3 id="6-2、加载Nacos配置"><a href="#6-2、加载Nacos配置" class="headerlink" title="6.2、加载Nacos配置"></a>6.2、加载Nacos配置</h3><blockquote>
<p>在YDT_WebSites项目中Program类中加载Nacos配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">using YDT_WebSites.Data;</span><br><span class="line">using Serilog;</span><br><span class="line">using Serilog.Events;</span><br><span class="line">using Volo.Abp.Data;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites;</span><br><span class="line"></span><br><span class="line">public class Program</span><br><span class="line">&#123;</span><br><span class="line">    public async static Task&lt;int&gt; Main(string[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        var loggerConfiguration = new LoggerConfiguration()</span><br><span class="line">#if DEBUG</span><br><span class="line">            .MinimumLevel.Debug()</span><br><span class="line">#else</span><br><span class="line">            .MinimumLevel.Information()</span><br><span class="line">#endif</span><br><span class="line">            .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Information)</span><br><span class="line">            .MinimumLevel.Override(&quot;Microsoft.EntityFrameworkCore&quot;, LogEventLevel.Warning)</span><br><span class="line">            .Enrich.FromLogContext()</span><br><span class="line">            .WriteTo.Async(c =&gt; c.File(&quot;Logs/logs.txt&quot;))</span><br><span class="line">            .WriteTo.Async(c =&gt; c.Console());</span><br><span class="line"></span><br><span class="line">        if (IsMigrateDatabase(args))</span><br><span class="line">        &#123;</span><br><span class="line">            loggerConfiguration.MinimumLevel.Override(&quot;Volo.Abp&quot;, LogEventLevel.Warning);</span><br><span class="line">            loggerConfiguration.MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Warning);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.Logger = loggerConfiguration.CreateLogger();</span><br><span class="line"></span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            var builder = WebApplication.CreateBuilder(args);</span><br><span class="line">            builder.Host.AddAppSettingsSecretsJson()</span><br><span class="line">                .UseAutofac()</span><br><span class="line">                .UseSerilog();</span><br><span class="line">            if (IsMigrateDatabase(args))</span><br><span class="line">            &#123;</span><br><span class="line">                builder.Services.AddDataMigrationEnvironment();</span><br><span class="line">            &#125;</span><br><span class="line">            await builder.AddApplicationAsync&lt;YDT_WebSitesModule&gt;();</span><br><span class="line"></span><br><span class="line">            // 1、加载Nacos配置</span><br><span class="line">            var configuration = builder.Configuration;</span><br><span class="line">            configuration.AddNacosV2Configuration(configuration.GetSection(&quot;Nacos&quot;));// 加载Nacos配置。</span><br><span class="line"></span><br><span class="line">            var app = builder.Build();</span><br><span class="line">            await app.InitializeApplicationAsync();</span><br><span class="line"></span><br><span class="line">            Log.Information(&quot;Starting YDT_WebSites.&quot;);</span><br><span class="line">            await app.RunAsync();</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            if (ex is HostAbortedException)</span><br><span class="line">            &#123;</span><br><span class="line">                throw;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.Fatal(ex, &quot;YDT_WebSites terminated unexpectedly!&quot;);</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        finally</span><br><span class="line">        &#123;</span><br><span class="line">            Log.CloseAndFlush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static bool IsMigrateDatabase(string[] args)</span><br><span class="line">    &#123;</span><br><span class="line">        return args.Any(x =&gt; x.Contains(&quot;--migrate-database&quot;, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-3、使用Nacos"><a href="#6-3、使用Nacos" class="headerlink" title="6.3、使用Nacos"></a>6.3、使用Nacos</h3><blockquote>
<p>含义：在YDT_WebSites项目中的使用Nacos中配置文件<br>技术：IConfiguration<br>流程：在YDT_WebSites项目IndexController类中通过IConfiguration使用Nacos</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Caching;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 首页控制器（查询商品数据）</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;Index&quot;)]</span><br><span class="line">public class IndexController : AbpController</span><br><span class="line">&#123;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IConfiguration</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IConfiguration Configuration &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取页面上的商品数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProduct()</span><br><span class="line">    &#123;</span><br><span class="line">        // 2、获取appsetting.json文件中的内容</span><br><span class="line">        string website = Configuration[&quot;website&quot;];</span><br><span class="line">     </span><br><span class="line">        //1、查询商品</span><br><span class="line">        return productService.GetProductsAsync().Result;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-4、启动商品微服务"><a href="#6-4、启动商品微服务" class="headerlink" title="6.4、启动商品微服务"></a>6.4、启动商品微服务</h3><p>进入YDT_WebSites项目工作目录中。使用以下命令启动</p>
<p>dotnet run</p>
<h2 id="7、配置中心应用-服务降级"><a href="#7、配置中心应用-服务降级" class="headerlink" title="7、配置中心应用-服务降级"></a>7、配置中心应用-服务降级</h2><blockquote>
<p>服务降级：动态改动服务接口功能。<br>例如：查询MySQL中商品数据，换成查询redis中的商品数据。<br>例如：查询redis中的商品数据。换成查询MySQL中商品数据</p>
</blockquote>
<blockquote>
<p>服务降级应用场景：大促期间，如果并发大了。换成查询redis。<br>大促已过，如果并发小了。换成查询mysql。</p>
</blockquote>
<blockquote>
<p>目标：当查询商品的时候，将查询MySQL数据库，切换到查询redis。</p>
</blockquote>
<h3 id="7-1、前提"><a href="#7-1、前提" class="headerlink" title="7.1、前提"></a>7.1、前提</h3><blockquote>
<p>含义： 电商网站中商品数据存储到redis中。<br>技术：Volo.Abp.Caching.StackExchangeRedis</p>
</blockquote>
<h3 id="7-2、redis准备"><a href="#7-2、redis准备" class="headerlink" title="7.2、redis准备"></a>7.2、redis准备</h3><ul>
<li><p>1、下载redis</p>
<pre><code>  地址：https://redis.io/download/
</code></pre>
</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-65.png" alt="Alt text"></p>
<ul>
<li>2、启动redis</li>
</ul>
<blockquote>
<p>windows10 上直接启动，切换到F:\work.net_software\redis目录中。使用CMD，输入以下命令。然后直接启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server.exe redis.windows.conf</span><br></pre></td></tr></table></figure>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-66.png" alt="Alt text"></p>
<ul>
<li>3、访问redis</li>
</ul>
<blockquote>
<p>使用redis客户端访问nacos</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-67.png" alt="Alt text"></p>
<h3 id="7-3、电商网站准备"><a href="#7-3、电商网站准备" class="headerlink" title="7.3、电商网站准备"></a>7.3、电商网站准备</h3><ul>
<li>1、安装Volo.Abp.Caching.StackExchangeRedis</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中使用nuget安装Volo.Abp.Caching.StackExchangeRedis</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-68.png" alt="Alt text"></p>
<ul>
<li>2、集成Volo.Abp.Caching.StackExchangeRedis</li>
</ul>
<blockquote>
<p>在YDT_WebSitesModule类中集成集成Volo.Abp.Caching.StackExchangeRedis</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_WebSites.Data;</span><br><span class="line">using YDT_WebSites.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using Volo.Abp.Http.Client;</span><br><span class="line">using Volo.Abp.Caching.StackExchangeRedis;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule),</span><br><span class="line">    typeof(AbpHttpClientModule),</span><br><span class="line">    typeof(AbpCachingStackExchangeRedisModule) // 集成Volo.Abp.Caching.StackExchangeRedis</span><br><span class="line">)]</span><br><span class="line">public class YDT_WebSitesModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line">    public override void PreConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        context.Services.PreConfigure&lt;AbpMvcDataAnnotationsLocalizationOptions&gt;(options =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            options.AddAssemblyResource(</span><br><span class="line">                typeof(YDT_WebSitesResource)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3、配置Volo.Abp.Caching.StackExchangeRedis</li>
</ul>
<blockquote>
<p>在appsettings.json配置文件中配置Volo.Abp.Caching.StackExchangeRedis</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> ....</span><br><span class="line">  &quot;Redis&quot;: &#123;</span><br><span class="line">    &quot;Configuration&quot;: &quot;localhost:6379&quot;,</span><br><span class="line">    &quot;IsEnabled&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置解析：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;Redis&quot;: &#123;</span><br><span class="line">    &quot;Configuration&quot;: &quot;localhost:6379&quot;, #redis连接地址</span><br><span class="line">    &quot;IsEnabled&quot;: true #是否开启redis配置</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>4、使用Volo.Abp.Caching.StackExchangeRedis</p>
<pre><code>  技术：IDistributedCache
</code></pre>
</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中IndexController类中使用Volo.Abp.Caching.StackExchangeRedis</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Caching;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 首页控制器（查询商品数据）</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;Index&quot;)]</span><br><span class="line">public class IndexController : AbpController</span><br><span class="line">&#123;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IConfiguration</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IConfiguration Configuration &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IDistributedCache</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IDistributedCache&lt;List&lt;ProductDto&gt;&gt; distributedCache &#123; set; get; &#125;   </span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取页面上的商品数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProduct()</span><br><span class="line">    &#123;</span><br><span class="line">        // 2、获取appsetting.json文件中的内容</span><br><span class="line">        string website = Configuration[&quot;website&quot;];</span><br><span class="line"></span><br><span class="line">        // 1、查询商品，从数据库</span><br><span class="line">        List&lt;ProductDto&gt; = productDtos = productService.GetProductsAsync().Result;</span><br><span class="line">            </span><br><span class="line">        // 2、商品数据存储到redis中</span><br><span class="line">        distributedCache.Set(&quot;productDtos&quot;, productDtos);</span><br><span class="line">        return productDtos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-4、服务降级"><a href="#7-4、服务降级" class="headerlink" title="7.4、服务降级"></a>7.4、服务降级</h3><blockquote>
<p>目标：当查询商品的时候，将查询MySQL数据库，切换到查询redis<br>技术：websiteDegrade</p>
</blockquote>
<ul>
<li>1、配置websiteDegrade</li>
</ul>
<blockquote>
<p>在nacos首页中的website组下的appsettings.json配置文件中配置websiteDegrade</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  .....</span><br><span class="line">  &quot;website&quot;:&quot;开启&quot;,</span><br><span class="line">  &quot;websiteDegrade&quot;:&quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置解析：</p>
</blockquote>
<pre><code>websiteDegrade：为服务降级配置 1为 mysql 2为redis
</code></pre>
<ul>
<li>2、使用websiteDegrade</li>
</ul>
<blockquote>
<p>在IndexController类中使用websiteDegrade</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Caching;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 首页控制器（查询商品数据）</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;Index&quot;)]</span><br><span class="line">public class IndexController : AbpController</span><br><span class="line">&#123;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IConfiguration</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IConfiguration Configuration &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IDistributedCache</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IDistributedCache&lt;List&lt;ProductDto&gt;&gt; distributedCache &#123; set; get; &#125;   </span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取页面上的商品数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProduct()</span><br><span class="line">    &#123;</span><br><span class="line">        // 2、获取appsetting.json文件中的内容</span><br><span class="line">        string website = Configuration[&quot;website&quot;];</span><br><span class="line"></span><br><span class="line">        //2.1、获取appsetting.json文件中的websiteDegrade内容</span><br><span class="line">        string websiteDegrade = Configuration[&quot;websiteDegrade&quot;];</span><br><span class="line"></span><br><span class="line">        //1、查询商品</span><br><span class="line">        // return productService.GetListAsync(new PagedAndSortedResultRequestDto()).Result.Items.ToList();</span><br><span class="line">        List&lt;ProductDto&gt; productDtos = null;</span><br><span class="line">        if (websiteDegrade.Equals(&quot;1&quot;))</span><br><span class="line">        &#123;</span><br><span class="line">            // 1、查询商品，从数据库</span><br><span class="line">             productDtos = productService.GetProductsAsync().Result;</span><br><span class="line">            // 2、商品数据存储到redis中</span><br><span class="line">            distributedCache.Set(&quot;productDtos&quot;, productDtos);</span><br><span class="line">        &#125;</span><br><span class="line">        else if(websiteDegrade.Equals(&quot;2&quot;))</span><br><span class="line">        &#123;</span><br><span class="line">            // 3、商品数据查询从redis中</span><br><span class="line">            productDtos = distributedCache.Get(&quot;productDtos&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return productDtos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/04/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/4%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%BD%91%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/04/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/4%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%BD%91%E5%85%B3/" class="post-title-link" itemprop="url">4、千万级秒杀项目实战网关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-04 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-04T10:48:57+08:00">2023-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-19 16:40:53" itemprop="dateModified" datetime="2024-02-19T16:40:53+08:00">2024-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/04/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/4%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%BD%91%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/04/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/4%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%BD%91%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h1><p>落地网关思路。<br>1、先创建网关<br>2、将网关转换成abp项目<br>3、将abp网关项目转换成为能够微服务项目<br>4、将abp网关集成微服务API项目<br>5、使用网关访问微服务</p>
<p>浏览器—-&gt;访问API网关—&gt;Ocelot—-&gt;consul—&gt;商品微服务</p>
<h3 id="将网关项目转成ABP-vNext-项目"><a href="#将网关项目转成ABP-vNext-项目" class="headerlink" title="将网关项目转成ABP vNext 项目"></a>将网关项目转成ABP vNext 项目</h3><ul>
<li>引入ABP相关Nuget包<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-77.png" alt="Alt text"></li>
<li>创建Module 类<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-78.png" alt="Alt text"></li>
</ul>
<h3 id="将当前项目转换成能访问微服务的项目"><a href="#将当前项目转换成能访问微服务的项目" class="headerlink" title="将当前项目转换成能访问微服务的项目"></a>将当前项目转换成能访问微服务的项目</h3><ul>
<li><p>引入 Ocelot 包<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-79.png" alt="Alt text"></p>
</li>
<li><p>appsettings.json 配置能访问其他微服务的网关地址<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-80.png" alt="Alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Routes&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/ProductService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/ProductService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;ServiceName&quot;: &quot;productservices&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/OrderService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/OrderService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;ServiceName&quot;: &quot;orderservices&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/PaymentService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/PaymentService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;ServiceName&quot;: &quot;paymentservices&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/SeckillService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/SeckillService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;ServiceName&quot;: &quot;seckillservices&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/UserService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/UserService/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;ServiceName&quot;: &quot;userservices&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;GlobalConfiguration&quot;: &#123;</span><br><span class="line">    &quot;BaseUrl&quot;: &quot;http://localhost:5005&quot;,</span><br><span class="line">    &quot;ServiceDiscoveryProvider&quot;: &#123;</span><br><span class="line">      &quot;Scheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">      &quot;Port&quot;: 8500,</span><br><span class="line">      &quot;Type&quot;: &quot;Consul&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;Logging&quot;: &#123;</span><br><span class="line">    &quot;LogLevel&quot;: &#123;</span><br><span class="line">      &quot;Default&quot;: &quot;Warning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;AllowedHosts&quot;: &quot;*&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 Ocelot 服务及配置<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-81.png" alt="Alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 1、添加ocelot</span><br><span class="line">context.Services.AddOcelot(context.Services.GetConfiguration())</span><br><span class="line">                .AddConsul();</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Ocelot<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-82.png" alt="Alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 2、使用ocelot</span><br><span class="line">app.UseOcelot().Wait();</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="将所有微服务的API接口，添加到网关里面"><a href="#将所有微服务的API接口，添加到网关里面" class="headerlink" title="将所有微服务的API接口，添加到网关里面"></a>将所有微服务的API接口，添加到网关里面</h3><ul>
<li><p>网关项目添加其他微服务的应用<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-83.png" alt="Alt text"><br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-84.png" alt="Alt text"></p>
</li>
<li><p>关闭生成控制器，不需要生成对应的控制器，只需要展示API<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-85.png" alt="Alt text"><br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-86.png" alt="Alt text"></p>
</li>
<li><p>继承 Autofac<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-87.png" alt="Alt text"></p>
</li>
<li><p>启动项目，实现把所有微服务注册到网关<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-88.png" alt="Alt text"></p>
</li>
<li><p>此时执行相应API端口，对应的执行到微服务项目<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-89.png" alt="Alt text"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83consul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83consul/" class="post-title-link" itemprop="url">4、微服务-注册中心consul</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-04 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-04T10:48:57+08:00">2023-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-08 22:03:24" itemprop="dateModified" datetime="2024-02-08T22:03:24+08:00">2024-02-08</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83consul/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83consul/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="4、微服务-注册中心consul"><a href="#4、微服务-注册中心consul" class="headerlink" title="4、微服务-注册中心consul"></a>4、微服务-注册中心consul</h1><p>Consul是HashiCorp公司推出的开源工具，用于实现分布式系统的服务发现与配置。内置了服务注册与发现框 架、分布一致性协议实现、健康检查、Key&#x2F;Value存储、多数据中心方案，不再需要依赖其他工具（比如ZooKeeper等），使用起来也较 为简单。</p>
<p>Consul用Golang实现，因此具有天然可移植性（支持Linux、windows和Mac OS X）；安装包仅包含一个可执行文件，方便部署，与Docker等轻量级容器可无缝配合。</p>
<h2 id="服务的可伸缩-Consul"><a href="#服务的可伸缩-Consul" class="headerlink" title="服务的可伸缩 Consul"></a>服务的可伸缩 Consul</h2><blockquote>
<p>在高峰时，可以扩展或缩小服务集群<br>集群：相同的实例，干相同的活， nginx</p>
</blockquote>
<p>基于集群去完成高可用以及伸缩性</p>
<h2 id="1、注册中心"><a href="#1、注册中心" class="headerlink" title="1、注册中心"></a>1、注册中心</h2><blockquote>
<p>注册中心：管理所有微服务地址<br>例如：这是微服务地址：直接给<strong><a target="_blank" rel="noopener" href="http://localhost:8090/">http://localhost:8090</a></strong>注册中心管理</p>
</blockquote>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-37.png" alt="Alt text"></p>
<h2 id="2、注册中心应用场景"><a href="#2、注册中心应用场景" class="headerlink" title="2、注册中心应用场景"></a>2、注册中心应用场景</h2><blockquote>
<p>电商微服务网站如图所示：使用API网关实现客户端查询商品业务场景。</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-38.png" alt="Alt text"></p>
<ul>
<li><p>查询商品实现流程</p>
<pre><code>  客户端——电商网站—–API网关—–商品微服务——商品数据库
</code></pre>
</li>
</ul>
<blockquote>
<p>问题：如何增加新微服务，订单微服务，商品微服务集群，会导致API不断修改的修改，违背开闭原则<br>答案：使用注册中心</p>
</blockquote>
<p>架构图如下：</p>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-39.png" alt="Alt text"></p>
<ul>
<li>总结：以上是微服务，使用注册中心的架构图。</li>
</ul>
<blockquote>
<p>好处：注册中心，是AIP遵守开闭原则。同时保证微服务动态伸缩，API网关和各个微服务之间独立变化发展。</p>
</blockquote>
<h2 id="3、注册中心技术选项"><a href="#3、注册中心技术选项" class="headerlink" title="3、注册中心技术选项"></a>3、注册中心技术选项</h2><ul>
<li>注册中心技术：</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-40.png" alt="Alt text"></p>
<pre><code>1、zookeeper

2、consul go语言

3、etcd

4、eureka

5、nacos
</code></pre>
<blockquote>
<p>根据技术4个特点来进行选型。</p>
</blockquote>
<pre><code>1、功能多

2、稳定强

3、性能高

4、使用简单
</code></pre>
<blockquote>
<p>4个方面进行技术选型</p>
</blockquote>
<h2 id="4、注册中心落地"><a href="#4、注册中心落地" class="headerlink" title="4、注册中心落地"></a>4、注册中心落地</h2><blockquote>
<p>含义：商品微服务地址注册到注册中心，API网关从注册中心获取商品微服务地址</p>
</blockquote>
<ul>
<li>技术：consul，Ocelot.Provider.Consul</li>
</ul>
<h3 id="4-1、注册中心准备"><a href="#4-1、注册中心准备" class="headerlink" title="4.1、注册中心准备"></a>4.1、注册中心准备</h3><ul>
<li><p>1、下载consul</p>
<pre><code>  地址：https://developer.hashicorp.com/consul
</code></pre>
</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-41.png" alt="Alt text"></p>
<ul>
<li>2、启动consul</li>
</ul>
<blockquote>
<p>windows10 上直接启动，切换到F:\work.net_project\奕鼎通.NetP6架构2307班\第六章 微服务项目实战\4、微服务-注册中心consul 目录中。使用CMD，输入以下命令。然后直接启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul.exe agent -dev</span><br></pre></td></tr></table></figure>

<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-42.png" alt="Alt text"></p>
<h3 id="4-2、商品微服务准备"><a href="#4-2、商品微服务准备" class="headerlink" title="4.2、商品微服务准备"></a>4.2、商品微服务准备</h3><ul>
<li>1、安装Consul</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中使用nuget安装Consul</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-43.png" alt="Alt text"></p>
<ul>
<li>2、使用Consul</li>
</ul>
<blockquote>
<p>含义：就是把商品微服务地址<a href="http://localhost:44378给consul">http://localhost:44378给consul</a></p>
</blockquote>
<ul>
<li>3、创建ConsulServiceRegistry</li>
</ul>
<blockquote>
<p>在Registrys目录中创建ConsulServiceRegistry，如果没有Registrys目录，直接在项目中创建。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">using Autofac.Core;</span><br><span class="line">using Consul;</span><br><span class="line">using Microsoft.Extensions.Options;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Registrys</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 服务注册类</span><br><span class="line">    /// http://localhost:44376 给consul</span><br><span class="line">    /// http://localhost:44376</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class ConsulServiceRegistry</span><br><span class="line">    &#123;</span><br><span class="line">        public ServiceRegistryOptions serviceRegistryOptions;</span><br><span class="line"></span><br><span class="line">        public ConsulServiceRegistry(IOptions&lt;ServiceRegistryOptions&gt; options)</span><br><span class="line">        &#123;</span><br><span class="line">            this.serviceRegistryOptions = options.Value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 实现服务注册</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public void Registry()</span><br><span class="line">        &#123;</span><br><span class="line">            // 1、创建consul服务器连接</span><br><span class="line">            var consulClient = new ConsulClient(configuration =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                //1.1 填写consul服务地址</span><br><span class="line">                configuration.Address = new Uri(serviceRegistryOptions.ConsulAddress);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            // 2、创建服务地址</span><br><span class="line">            var uri = new Uri(serviceRegistryOptions.ServiceAddress);</span><br><span class="line"></span><br><span class="line">            // 3、注册服务地址</span><br><span class="line">            // 3.1、准备 AgentServiceRegistration</span><br><span class="line">            var registration = new AgentServiceRegistration()</span><br><span class="line">            &#123;</span><br><span class="line">                ID = serviceRegistryOptions.serviceID,</span><br><span class="line">                Name = serviceRegistryOptions.ServiceName,</span><br><span class="line">                Address = uri.Host, // localhost</span><br><span class="line">                Port = uri.Port, // 44376</span><br><span class="line">                Tags = new string[] &#123; &#125;,</span><br><span class="line">                Check = new AgentServiceCheck  // 检测微服务是否正常</span><br><span class="line">                &#123;</span><br><span class="line">                    // 3.1、consul健康检查超时间</span><br><span class="line">                    Timeout = TimeSpan.FromSeconds(10),</span><br><span class="line">                    // 3.2、服务停止5秒后注销服务</span><br><span class="line">                    DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(5),</span><br><span class="line">                    // 3.3、consul健康检查地址</span><br><span class="line">                    HTTP = serviceRegistryOptions.HealthCheckAddress,</span><br><span class="line">                    // 3.4 consul健康检查间隔时间</span><br><span class="line">                    Interval = TimeSpan.FromSeconds(10),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            // 3.2、注册服务地址</span><br><span class="line">            consulClient.Agent.ServiceRegister(registration).Wait();</span><br><span class="line"></span><br><span class="line">            // 4、服务注册成功</span><br><span class="line"></span><br><span class="line">            Console.WriteLine($&quot;微服务地址注册成功：&#123;serviceRegistryOptions.ServiceAddress&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 服务删除</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public void DeRegistry()</span><br><span class="line">        &#123;</span><br><span class="line">            // 1、创建consul服务器连接</span><br><span class="line">            var consulClient = new ConsulClient(configuration =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                //1.1 填写consul服务地址</span><br><span class="line">                configuration.Address = new Uri(&quot;http://localhost:8500/&quot;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            //2、服务删除</span><br><span class="line">            consulClient.Agent.ServiceDeregister(serviceRegistryOptions.serviceID).Wait();</span><br><span class="line"></span><br><span class="line">            //3、服务删除成功</span><br><span class="line">            Console.WriteLine($&quot;微服务地址删除成功：&#123;serviceRegistryOptions.ServiceAddress&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>4、创建ServiceRegistryHostService</li>
</ul>
<blockquote>
<p>在Registrys目录中创建ServiceRegistryHostService类</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">namespace YDT_ProductService.Registrys</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 启动项目，实现服务注册</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class ServiceRegistryHostService : IHostedService</span><br><span class="line">    &#123;</span><br><span class="line">        public ConsulServiceRegistry consulServiceRegistry &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">        public ServiceRegistryHostService(ConsulServiceRegistry consulServiceRegistry)</span><br><span class="line">        &#123;</span><br><span class="line">            this.consulServiceRegistry = consulServiceRegistry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 项目启动，调用服务注册方法</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;cancellationToken&quot;&gt;&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">        public Task StartAsync(CancellationToken cancellationToken)</span><br><span class="line">        &#123;</span><br><span class="line">            consulServiceRegistry.Registry();</span><br><span class="line">            return Task.CompletedTask;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 项目关闭，调用服务删除方法</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        /// &lt;param name=&quot;cancellationToken&quot;&gt;&lt;/param&gt;</span><br><span class="line">        /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">        public Task StopAsync(CancellationToken cancellationToken)</span><br><span class="line">        &#123;</span><br><span class="line">            consulServiceRegistry.DeRegistry();</span><br><span class="line">            return Task.CompletedTask;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>5、创建ServiceRegistryOptions</li>
</ul>
<blockquote>
<p>在Registrys目录中创建ServiceRegistryOptions类</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">namespace YDT_ProductService.Registrys</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取配置中的值</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class ServiceRegistryOptions</span><br><span class="line">    &#123;</span><br><span class="line">        public ServiceRegistryOptions()</span><br><span class="line">        &#123;</span><br><span class="line">            this.serviceID = Guid.NewGuid().ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public string serviceID &#123; set; get; &#125;</span><br><span class="line">        public string ConsulAddress &#123; set; get; &#125;</span><br><span class="line">        public string ServiceAddress &#123; set; get; &#125;</span><br><span class="line">        public string ServiceName &#123; set; get; &#125;</span><br><span class="line">        public string HealthCheckAddress &#123; set; get; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>6、配置appsettings.json</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中配置appsettings.json</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  &quot;ServiceRegistry&quot;: &#123;</span><br><span class="line">    &quot;ConsulAddress&quot;: &quot;http://localhost:8500/&quot;,</span><br><span class="line">    &quot;ServiceAddress&quot;: &quot;http://localhost:44378/&quot;,</span><br><span class="line">    &quot;ServiceName&quot;: &quot;productservice&quot;,</span><br><span class="line">    &quot;HealthCheckAddress&quot;: &quot;http://localhost:44378/HealthCheck&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>ConsulAddress：consul地址

ServiceAddress：商品微服务地址

ServiceName：商品微服务名称

HealthCheckAddress：心态校测地址
</code></pre>
<ul>
<li>7、配置心跳检测</li>
</ul>
<blockquote>
<p>在YDT_ProductServiceModule类中进行配置心态检测</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_ProductService.Data;</span><br><span class="line">using YDT_ProductService.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using YDT_ProductService.Registrys;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule)</span><br><span class="line">)]</span><br><span class="line">public class YDT_ProductServiceModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">		....</span><br><span class="line">        // 1、注册心跳检测</span><br><span class="line">        context.Services.AddHealthChecks();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnApplicationInitialization(ApplicationInitializationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">       ....</span><br><span class="line"></span><br><span class="line">        // 2、注册心跳检测中间件（类似于控制器）</span><br><span class="line">        app.UseHealthChecks(&quot;/HealthCheck&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>8、注册ServiceRegistryHostService，</li>
</ul>
<blockquote>
<p>在YDT_ProductServiceModule类中注册ServiceRegistryHostService，ConsulServiceRegistry，ServiceRegistryOptions</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_ProductService.Data;</span><br><span class="line">using YDT_ProductService.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using YDT_ProductService.Registrys;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule)</span><br><span class="line">)]</span><br><span class="line">public class YDT_ProductServiceModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        .....</span><br><span class="line"></span><br><span class="line">        // 2、注册ConsulServiceRegistry</span><br><span class="line">        context.Services.AddSingleton&lt;ConsulServiceRegistry&gt;();</span><br><span class="line">        // 3、注册ServiceRegistryHostService</span><br><span class="line">        context.Services.AddHostedService&lt;ServiceRegistryHostService&gt;();</span><br><span class="line">        // 4、注册ServiceRegistryOptions (获取值，然后注册 到IOC容器)</span><br><span class="line">        context.Services.Configure&lt;ServiceRegistryOptions&gt;(configuration.GetSection(&quot;ServiceRegistry&quot;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>9、启动商品微服务</li>
</ul>
<blockquote>
<p>进入YDT_ProductService项目目录中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>
<h3 id="4-2、API网关准备"><a href="#4-2、API网关准备" class="headerlink" title="4.2、API网关准备"></a>4.2、API网关准备</h3><ul>
<li>1、安装Ocelot.Provider.Consul</li>
</ul>
<blockquote>
<p>在YDT_Gateway项目中使用nuget安装Ocelot.Provider.Consul</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-44.png" alt="Alt text"></p>
<ul>
<li>2、集成Ocelot.Provider.Consul</li>
</ul>
<blockquote>
<p>含义：API网关项目中，使用ocelot集成Ocelot.Provider.Consul<br>在YDT_GatewayModule类中集成Ocelot.Provider.Consul</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_Gateway.Data;</span><br><span class="line">using YDT_Gateway.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using Ocelot.DependencyInjection;</span><br><span class="line">using Ocelot.Middleware;</span><br><span class="line">using Ocelot.Provider.Consul;</span><br><span class="line">using Ocelot.Provider.Polly;</span><br><span class="line">using Ocelot.Cache.CacheManager;</span><br><span class="line"></span><br><span class="line">namespace YDT_Gateway;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule)</span><br><span class="line"></span><br><span class="line">)]</span><br><span class="line">public class YDT_GatewayModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">       </span><br><span class="line">        .....</span><br><span class="line">        // 1、集成Ocelot()</span><br><span class="line">        context.Services.AddOcelot(context.Services.GetConfiguration())</span><br><span class="line">                         .AddConsul(); // 2、集成Ocelot.Provider.Consul</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3、使用Ocelot.Provider.Consul</li>
</ul>
<blockquote>
<p>含义：API网关从consul中获取商品微服务地址<a target="_blank" rel="noopener" href="http://localhost:44378/">http://localhost:44378</a><br>在appsettings.json使用Ocelot.Provider.Consul</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  &quot;Routes&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      /**</span><br><span class="line">      &quot;DownstreamHostAndPorts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">          &quot;Port&quot;: 44378</span><br><span class="line">        &#125;</span><br><span class="line">      ],**/</span><br><span class="line">      &quot;ServiceName&quot;: &quot;productservice&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;LeastConnection&quot; /**RoundRobin*/</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;GlobalConfiguration&quot;: &#123;</span><br><span class="line">    &quot;BaseUrl&quot;: &quot;http://localhost:44368&quot;,</span><br><span class="line">    &quot;ServiceDiscoveryProvider&quot;: &#123;</span><br><span class="line">      &quot;Scheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">      &quot;Port&quot;: 8500,</span><br><span class="line">      &quot;Type&quot;: &quot;Consul&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>4、启动YDT_Gateway网关项目</li>
</ul>
<blockquote>
<p>进入YDT_Gateway项目工作目录中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>
<h2 id="5、API网关限流落地"><a href="#5、API网关限流落地" class="headerlink" title="5、API网关限流落地"></a>5、API网关限流落地</h2><blockquote>
<p>含义：限制客户端请求数进入到商品微服务。<br>例如：客户端发起1000个请求，只允许500个请求，进入到商品微服务</p>
</blockquote>
<ul>
<li>1、配置限流</li>
</ul>
<blockquote>
<p>在appsettings.json中配置限流</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  &quot;Routes&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      /**</span><br><span class="line">      &quot;DownstreamHostAndPorts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">          &quot;Port&quot;: 44378</span><br><span class="line">        &#125;</span><br><span class="line">      ],**/</span><br><span class="line">      &quot;ServiceName&quot;: &quot;productservice&quot;,</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;LeastConnection&quot; /**RoundRobin*/</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;RateLimitOptions&quot;: &#123;</span><br><span class="line">        &quot;ClientWhitelist&quot;: [],</span><br><span class="line">        &quot;EnableRateLimiting&quot;: true,</span><br><span class="line">        &quot;Period&quot;: &quot;2s&quot;,</span><br><span class="line">        &quot;PeriodTimespan&quot;: 2,</span><br><span class="line">        &quot;Limit&quot;: 1000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;GlobalConfiguration&quot;: &#123;</span><br><span class="line">    &quot;BaseUrl&quot;: &quot;http://localhost:44368&quot;,</span><br><span class="line">    &quot;ServiceDiscoveryProvider&quot;: &#123;</span><br><span class="line">      &quot;Scheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">      &quot;Port&quot;: 8500,</span><br><span class="line">      &quot;Type&quot;: &quot;Consul&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置解析：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;RateLimitOptions&quot;: &#123;</span><br><span class="line">        &quot;ClientWhitelist&quot;: [], #哪些客户不限流，填写不限流IP地址</span><br><span class="line">        &quot;EnableRateLimiting&quot;: true, #开启限流</span><br><span class="line">        &quot;Period&quot;: &quot;2s&quot;, #限流时间，2s内只允许多少个请求。</span><br><span class="line">        &quot;PeriodTimespan&quot;: 2, #限流解除。2s后可以重新开始请求</span><br><span class="line">        &quot;Limit&quot;: 1000 # 2s内只允许1000个请求</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6、API网关熔断落地"><a href="#6、API网关熔断落地" class="headerlink" title="6、API网关熔断落地"></a>6、API网关熔断落地</h2><blockquote>
<p>含义：API网关发现商品微服务已经宕机，不再访问。<br>例如：商品微服务多个实例全部宕机，API网关访问的时候出现，直接断开API网关和商品微服务，防止系统因为宕机导致系统崩溃</p>
</blockquote>
<pre><code>技术：Ocelot.Provider.Polly
</code></pre>
<ul>
<li>1、安装Ocelot.Provider.Polly</li>
</ul>
<blockquote>
<p>在YDT_Gateway中安装Ocelot.Provider.Polly</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-45.png" alt="Alt text"></p>
<blockquote>
<p>配置解析：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;RateLimitOptions&quot;: &#123;</span><br><span class="line">        &quot;ClientWhitelist&quot;: [], #哪些客户不限流，填写不限流IP地址</span><br><span class="line">        &quot;EnableRateLimiting&quot;: true, #开启限流</span><br><span class="line">        &quot;Period&quot;: &quot;2s&quot;, #限流时间，2s内只允许多少个请求。</span><br><span class="line">        &quot;PeriodTimespan&quot;: 2, #限流解除。2s后可以重新开始请求</span><br><span class="line">        &quot;Limit&quot;: 1000 # 2s内只允许1000个请求</span><br><span class="line">      &#125;</span><br><span class="line">~~~   </span><br><span class="line">- 2、集成Ocelot.Provider.Polly</span><br><span class="line"></span><br><span class="line">&gt; 在YDT_GatewayModule类中集成Ocelot.Provider.Polly</span><br></pre></td></tr></table></figure>
<p>using Microsoft.AspNetCore.Cors;<br>using Microsoft.AspNetCore.DataProtection;<br>using Microsoft.Extensions.DependencyInjection.Extensions;<br>using Microsoft.OpenApi.Models;<br>using YDT_Gateway.Data;<br>using YDT_Gateway.Localization;<br>using Volo.Abp;<br>using Volo.Abp.Uow;<br>using Volo.Abp.AspNetCore.Mvc;<br>using Volo.Abp.AspNetCore.Mvc.Localization;<br>using Volo.Abp.AspNetCore.Serilog;<br>using Volo.Abp.Autofac;<br>using Volo.Abp.AutoMapper;<br>using Volo.Abp.EntityFrameworkCore;<br>using Volo.Abp.EntityFrameworkCore.MySQL;<br>using Volo.Abp.Localization;<br>using Volo.Abp.Localization.ExceptionHandling;<br>using Volo.Abp.Modularity;<br>using Volo.Abp.MultiTenancy;<br>using Volo.Abp.Swashbuckle;<br>using Volo.Abp.UI.Navigation.Urls;<br>using Volo.Abp.Validation.Localization;<br>using Volo.Abp.VirtualFileSystem;<br>using Ocelot.DependencyInjection;<br>using Ocelot.Middleware;<br>using Ocelot.Provider.Consul;<br>using Ocelot.Provider.Polly;<br>using Ocelot.Cache.CacheManager;</p>
<p>namespace YDT_Gateway;</p>
<p>[DependsOn(<br>    &#x2F;&#x2F; ABP Framework packages<br>    typeof(AbpAspNetCoreMvcModule),<br>    typeof(AbpAutofacModule),<br>    typeof(AbpAutoMapperModule),<br>    typeof(AbpEntityFrameworkCoreMySQLModule),<br>    typeof(AbpSwashbuckleModule),<br>    typeof(AbpAspNetCoreSerilogModule)</p>
<p>)]<br>public class YDT_GatewayModule : AbpModule<br>{</p>
<pre><code>public override void ConfigureServices(ServiceConfigurationContext context)
&#123;
     .....

    // 1、集成Ocelot
    context.Services.AddOcelot(context.Services.GetConfiguration())
                     .AddConsul()
                     .AddPolly();
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 3、使用Ocelot.Provider.Polly</span><br><span class="line"></span><br><span class="line">&gt; 在appsettings.json文件中集成Ocelot.Provider.Polly</span><br></pre></td></tr></table></figure>
<p>{<br>  ….<br>  “Routes”: [<br>    {<br>      “UpstreamPathTemplate”: “&#x2F;api&#x2F;app&#x2F;product&#x2F;{everything}”,<br>      “UpstreamHttpMethod”: [ “Put”, “Delete”, “Get”, “Post” ],<br>      “DownstreamPathTemplate”: “&#x2F;api&#x2F;app&#x2F;product&#x2F;{everything}”,<br>      “DownstreamScheme”: “http”,<br>      &#x2F;**<br>      “DownstreamHostAndPorts”: [<br>        {<br>          “Host”: “localhost”,<br>          “Port”: 44378<br>        }<br>      ],**&#x2F;<br>      “ServiceName”: “productservice”,<br>      “LoadBalancerOptions”: {<br>        “Type”: “LeastConnection” &#x2F;*<em>RoundRobin</em>&#x2F;<br>      },<br>      “RateLimitOptions”: {<br>        “ClientWhitelist”: [],<br>        “EnableRateLimiting”: true,<br>        “Period”: “2s”,<br>        “PeriodTimespan”: 2,<br>        “Limit”: 1000<br>      },<br>      “QoSOptions”: {<br>        “ExceptionsAllowedBeforeBreaking”: 1,<br>        “DurationOfBreak”: 10000,<br>        “TimeoutValue”: 5000<br>      }<br>    }<br>  ],<br>  “GlobalConfiguration”: {<br>    “BaseUrl”: “<a target="_blank" rel="noopener" href="http://localhost:44368/">http://localhost:44368</a>“,<br>    “ServiceDiscoveryProvider”: {<br>      “Scheme”: “http”,<br>      “Host”: “localhost”,<br>      “Port”: 8500,<br>      “Type”: “Consul”<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 配置解析：</span><br></pre></td></tr></table></figure>
<p>“QoSOptions”: {<br>        “ExceptionsAllowedBeforeBreaking”: 1, # 开启熔断条件，访问出现异常，开启熔断，默认1次异常<br>        “DurationOfBreak”: 10000,# 熔断时间，多长时间熔断解除，正常访问<br>        “TimeoutValue”: 5000 #熔断超时时间，用来当访问超时的时候，也开启熔断<br>      }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">## 7、API网关缓存落地</span><br><span class="line">&gt; 含义：API网关发现商品微服务访问性能低。提升访问性能</span><br><span class="line">例如：商品微服务多个实例全部正常，API网关访问的时候出现，时间比较长，为了缩短时间，就用缓存来缩短</span><br><span class="line"></span><br><span class="line">    技术：Ocelot.Cache.CacheManager</span><br><span class="line"></span><br><span class="line">- 1、安装Ocelot.Cache.CacheManager</span><br><span class="line"></span><br><span class="line">&gt; 在YDT_Gateway中安装Ocelot.Cache.CacheManager</span><br><span class="line"></span><br><span class="line">![Alt text](images微服务实战/image-46.png)</span><br><span class="line"></span><br><span class="line">- 2、集成Ocelot.Cache.CacheManager</span><br><span class="line"></span><br><span class="line">&gt; 在YDT_GatewayModule类中集成Ocelot.Cache.CacheManager</span><br></pre></td></tr></table></figure>
<p>using Microsoft.AspNetCore.Cors;<br>using Microsoft.AspNetCore.DataProtection;<br>using Microsoft.Extensions.DependencyInjection.Extensions;<br>using Microsoft.OpenApi.Models;<br>using YDT_Gateway.Data;<br>using YDT_Gateway.Localization;<br>using Volo.Abp;<br>using Volo.Abp.Uow;<br>using Volo.Abp.AspNetCore.Mvc;<br>using Volo.Abp.AspNetCore.Mvc.Localization;<br>using Volo.Abp.AspNetCore.Serilog;<br>using Volo.Abp.Autofac;<br>using Volo.Abp.AutoMapper;<br>using Volo.Abp.EntityFrameworkCore;<br>using Volo.Abp.EntityFrameworkCore.MySQL;<br>using Volo.Abp.Localization;<br>using Volo.Abp.Localization.ExceptionHandling;<br>using Volo.Abp.Modularity;<br>using Volo.Abp.MultiTenancy;<br>using Volo.Abp.Swashbuckle;<br>using Volo.Abp.UI.Navigation.Urls;<br>using Volo.Abp.Validation.Localization;<br>using Volo.Abp.VirtualFileSystem;<br>using Ocelot.DependencyInjection;<br>using Ocelot.Middleware;<br>using Ocelot.Provider.Consul;<br>using Ocelot.Provider.Polly;<br>using Ocelot.Cache.CacheManager;</p>
<p>namespace YDT_Gateway;</p>
<p>[DependsOn(<br>    &#x2F;&#x2F; ABP Framework packages<br>    typeof(AbpAspNetCoreMvcModule),<br>    typeof(AbpAutofacModule),<br>    typeof(AbpAutoMapperModule),<br>    typeof(AbpEntityFrameworkCoreMySQLModule),<br>    typeof(AbpSwashbuckleModule),<br>    typeof(AbpAspNetCoreSerilogModule)</p>
<p>)]<br>public class YDT_GatewayModule : AbpModule<br>{</p>
<pre><code>public override void ConfigureServices(ServiceConfigurationContext context)
&#123;
     .....

    // 1、集成Ocelot
    context.Services.AddOcelot(context.Services.GetConfiguration())
                     .AddConsul()
                     .AddPolly()
                     .AddCacheManager(x =&gt; x.WithDictionaryHandle());
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 3、使用Ocelot.Cache.CacheManager</span><br><span class="line"></span><br><span class="line">&gt; 在appsettings.json文件中集成Ocelot.Cache.CacheManager</span><br></pre></td></tr></table></figure>
<p>{<br>  ……<br>  “Routes”: [<br>    {<br>      “UpstreamPathTemplate”: “&#x2F;api&#x2F;app&#x2F;product&#x2F;{everything}”,<br>      “UpstreamHttpMethod”: [ “Put”, “Delete”, “Get”, “Post” ],<br>      “DownstreamPathTemplate”: “&#x2F;api&#x2F;app&#x2F;product&#x2F;{everything}”,<br>      “DownstreamScheme”: “http”,<br>      &#x2F;**<br>      “DownstreamHostAndPorts”: [<br>        {<br>          “Host”: “localhost”,<br>          “Port”: 44378<br>        }<br>      ],**&#x2F;<br>      “ServiceName”: “productservice”,<br>      “LoadBalancerOptions”: {<br>        “Type”: “LeastConnection” &#x2F;*<em>RoundRobin</em>&#x2F;<br>      },<br>      “RateLimitOptions”: {<br>        “ClientWhitelist”: [],<br>        “EnableRateLimiting”: true,<br>        “Period”: “2s”,<br>        “PeriodTimespan”: 2,<br>        “Limit”: 1000<br>      },<br>      “QoSOptions”: {<br>        “ExceptionsAllowedBeforeBreaking”: 1,<br>        “DurationOfBreak”: 10000,<br>        “TimeoutValue”: 5000<br>      },<br>      “FileCacheOptions”: {<br>        “TtlSeconds”: 1000,<br>        “Region”: “productservice”<br>      }<br>    }<br>  ],<br>  “GlobalConfiguration”: {<br>    “BaseUrl”: “<a target="_blank" rel="noopener" href="http://localhost:44368/">http://localhost:44368</a>“,<br>    “ServiceDiscoveryProvider”: {<br>      “Scheme”: “http”,<br>      “Host”: “localhost”,<br>      “Port”: 8500,<br>      “Type”: “Consul”<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 配置解析：</span><br></pre></td></tr></table></figure>
<p>“FileCacheOptions”: {<br>        “TtlSeconds”: 1000, # 缓存时间，商品数据缓存1000s，然后自动失效。<br>        “Region”: “productservice” # 缓存区域，缓存到哪里。名称可以自定义取<br>      }<br>~~~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/03/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/3%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98Cousol/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/03/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/3%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98Cousol/" class="post-title-link" itemprop="url">3、千万级秒杀项目实战Cousol</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-03 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-03T10:48:57+08:00">2023-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-19 16:40:53" itemprop="dateModified" datetime="2024-02-19T16:40:53+08:00">2024-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/03/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/3%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98Cousol/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/03/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/3%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98Cousol/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="微服务注册Consul"><a href="#微服务注册Consul" class="headerlink" title="微服务注册Consul"></a>微服务注册Consul</h1><p>1、基础设施层落地。落地的是微服务地址注册到领事中<br>2、商品微服务使用落地<br>3、订单微服务使用落地<br>4、用户微服务使用落地<br>5、支付微服务使用落地<br>6、秒杀微服务使用落地</p>
<h3 id="启动Consul"><a href="#启动Consul" class="headerlink" title="启动Consul"></a>启动Consul</h3><ul>
<li>访问Consul 网站<br>localhost：8500</li>
</ul>
<h3 id="将商品微服务注册到Consul"><a href="#将商品微服务注册到Consul" class="headerlink" title="将商品微服务注册到Consul"></a>将商品微服务注册到Consul</h3><h4 id="创建一个Consul项目"><a href="#创建一个Consul项目" class="headerlink" title="创建一个Consul项目"></a>创建一个Consul项目</h4><pre><code>YDT.Microservices.Infrastructure
</code></pre>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-65.png" alt="Alt text"><br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-76.png" alt="Alt text"></p>
<p>###实现将微服务封装到Consul里面的逻辑</p>
<h4 id="将当前项目转换成ABP-VNext项目"><a href="#将当前项目转换成ABP-VNext项目" class="headerlink" title="将当前项目转换成ABP VNext项目"></a>将当前项目转换成ABP VNext项目</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-66.png" alt="Alt text"><br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-67.png" alt="Alt text"></p>
<h4 id="将当前项目应用到商品微服务里面"><a href="#将当前项目应用到商品微服务里面" class="headerlink" title="将当前项目应用到商品微服务里面"></a>将当前项目应用到商品微服务里面</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-68.png" alt="Alt text"></p>
<h4 id="将Consul项目引入到商品微服务里面的Moudul类里面"><a href="#将Consul项目引入到商品微服务里面的Moudul类里面" class="headerlink" title="将Consul项目引入到商品微服务里面的Moudul类里面"></a>将Consul项目引入到商品微服务里面的Moudul类里面</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-69.png" alt="Alt text"></p>
<h4 id="增加相应的配置"><a href="#增加相应的配置" class="headerlink" title="增加相应的配置"></a>增加相应的配置</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-70.png" alt="Alt text"></p>
<h4 id="修改相应的配置类，增加Consul相关配置"><a href="#修改相应的配置类，增加Consul相关配置" class="headerlink" title="修改相应的配置类，增加Consul相关配置"></a>修改相应的配置类，增加Consul相关配置</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-71.png" alt="Alt text"></p>
<h4 id="修改项目的默认启动地址"><a href="#修改项目的默认启动地址" class="headerlink" title="修改项目的默认启动地址"></a>修改项目的默认启动地址</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-72.png" alt="Alt text"></p>
<h4 id="开启心跳检测的中间件"><a href="#开启心跳检测的中间件" class="headerlink" title="开启心跳检测的中间件"></a>开启心跳检测的中间件</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-73.png" alt="Alt text"></p>
<h4 id="启动项目，来到Consul官网，发现注册了商品微服务项目"><a href="#启动项目，来到Consul官网，发现注册了商品微服务项目" class="headerlink" title="启动项目，来到Consul官网，发现注册了商品微服务项目"></a>启动项目，来到Consul官网，发现注册了商品微服务项目</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-74.png" alt="Alt text"></p>
<h4 id="剩下的微服务项目配置跟商品微服务一样配置"><a href="#剩下的微服务项目配置跟商品微服务一样配置" class="headerlink" title="剩下的微服务项目配置跟商品微服务一样配置"></a>剩下的微服务项目配置跟商品微服务一样配置</h4><p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-75.png" alt="Alt text"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%80%9A%E4%BF%A1%E3%80%81API%E7%BD%91%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%80%9A%E4%BF%A1%E3%80%81API%E7%BD%91%E5%85%B3/" class="post-title-link" itemprop="url">3、微服务-通信、API网关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-03 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-03T10:48:57+08:00">2023-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-08 22:03:24" itemprop="dateModified" datetime="2024-02-08T22:03:24+08:00">2024-02-08</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%80%9A%E4%BF%A1%E3%80%81API%E7%BD%91%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/3%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E9%80%9A%E4%BF%A1%E3%80%81API%E7%BD%91%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="3、微服务-通信、API网关"><a href="#3、微服务-通信、API网关" class="headerlink" title="3、微服务-通信、API网关"></a>3、微服务-通信、API网关</h1><h2 id="一、API网关是什么"><a href="#一、API网关是什么" class="headerlink" title="一、API网关是什么"></a>一、API网关是什么</h2><p>　　API网关是微服务架构中的唯一入口，它提供一个单独且统一的API入口用于访问内部一个或多个API。它可以具有身份验证，监控，负载均衡，缓存，请求分片与管理，静态响应处理等。API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。通常，网关也是提供REST&#x2F;HTTP的访问API。服务端通过API-GW注册和管理服务。</p>
<h2 id="二、Ocelot简介"><a href="#二、Ocelot简介" class="headerlink" title="二、Ocelot简介"></a>二、Ocelot简介</h2><p>　　Ocelot 是一个用.NET Core实现并且开源的API网关，它功能强大，包括了：路由、请求聚合、服务发现、认证、鉴权、限流熔断、并内置了负载均衡器与Service Fabric、Butterfly Tracing集成。这些功能只都只需要简单的配置即可完成</p>
<h2 id="1、微服务通信"><a href="#1、微服务通信" class="headerlink" title="1、微服务通信"></a>1、微服务通信</h2><pre><code>微服务通信：各个微服务之间互相调用。
例如：电商网站调用商品微服务
</code></pre>
<h2 id="2、微服务通信应用场景"><a href="#2、微服务通信应用场景" class="headerlink" title="2、微服务通信应用场景"></a>2、微服务通信应用场景</h2><pre><code>电商网站如图所示：客户端查询商品业务场景。
</code></pre>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-31.png" alt="Alt text"></p>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-32.png" alt="Alt text"></p>
<pre><code>查询商品实现流程

客户端——电商网站——商品微服务——商品数据库

问题：电商网站如何调用商品微服务

答案：使用HTTP/gRPC

架构图如下：
</code></pre>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-33.png" alt="Alt text"></p>
<blockquote>
<p>总结：以上是微服务通信的应用场景。</p>
</blockquote>
<h2 id="3、微服务通信落地"><a href="#3、微服务通信落地" class="headerlink" title="3、微服务通信落地"></a>3、微服务通信落地</h2><pre><code>含义：电商网站调用商品微服务

技术：Volo.Abp.Http.Client
</code></pre>
<h3 id="3-1、商品微服务准备"><a href="#3-1、商品微服务准备" class="headerlink" title="3.1、商品微服务准备"></a>3.1、商品微服务准备</h3><ul>
<li>1、创建商品控制器</li>
</ul>
<blockquote>
<p>在YDT_ProductService项目中的Controllers目录中创建 ProductController控制器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line">using YDTProductService.Migrations;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 商品控制器</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;api/app/product&quot;)]</span><br><span class="line">public class ProductController : AbpController, IProductService</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IProductService</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125; </span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 添加商品方法</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpPost(&quot;AddProduct&quot;)]</span><br><span class="line">    public async Task&lt;ProductDto&gt; AddProduct(ProductDto productDto)</span><br><span class="line">    &#123;</span><br><span class="line">       // 1、实现添加商品</span><br><span class="line">       return await productService.CreateAsync(productDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPost]</span><br><span class="line">    public Task&lt;ProductDto&gt; CreateAsync(ProductDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpDelete]</span><br><span class="line">    public Task DeleteAsync(Guid id)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet(&quot;id&quot;)]</span><br><span class="line">    public Task&lt;ProductDto&gt; GetAsync(Guid id)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpGet]</span><br><span class="line">    public Task&lt;PagedResultDto&lt;ProductDto&gt;&gt; GetListAsync(PagedAndSortedResultRequestDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*/// &lt;summary&gt;</span><br><span class="line">    /// 1、查询商品列表</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet(&quot;GetProducts&quot;)]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProducts()</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、实现添加商品</span><br><span class="line">        return  productService.GetListAsync(new PagedAndSortedResultRequestDto())</span><br><span class="line">            .Result.Items.ToList();</span><br><span class="line">    &#125;*/</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 1、查询商品列表</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet(&quot;GetProducts&quot;)]</span><br><span class="line">    public async Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync()</span><br><span class="line">    &#123;</span><br><span class="line">        await Console.Out.WriteLineAsync(&quot;查询商品&quot;);</span><br><span class="line">        // 1、实现添加商品</span><br><span class="line">        return productService.GetListAsync(new PagedAndSortedResultRequestDto())</span><br><span class="line">            .Result.Items.ToList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [HttpPut]</span><br><span class="line">    public Task&lt;ProductDto&gt; UpdateAsync(Guid id, ProductDto input)</span><br><span class="line">    &#123;</span><br><span class="line">        throw new NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2、创建GetProductsAsync方法</li>
</ul>
<blockquote>
<p>在Services项目中的IProductService类中创建 GetProductsAsync();</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IProductService : ICrudAppService&lt;ProductDto,Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3、创建GetProductsAsync方法实现</li>
</ul>
<blockquote>
<p>在Services项目中的ProductService类中创建 GetProductsAsync()实现;</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line">using YDT_ProductService.Repositorys;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service实现</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [Dependency(ServiceLifetime.Singleton)]</span><br><span class="line">    public class ProductService : CrudAppService&lt;Product, ProductDto, Guid&gt;, IProductService</span><br><span class="line">    &#123;</span><br><span class="line">        public IProductRepository repository;</span><br><span class="line"></span><br><span class="line">        public ProductService(IProductRepository repository) : base(repository)</span><br><span class="line">        &#123;</span><br><span class="line">            this.repository = repository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync()</span><br><span class="line">        &#123;</span><br><span class="line">            //1、查询商品数据</span><br><span class="line">            List&lt;Product&gt; products  = repository.GetListAsync().Result;</span><br><span class="line"></span><br><span class="line">            // 2、商品转换为Dto</span><br><span class="line"></span><br><span class="line">            //3、返回List&lt;ProductDto&gt;</span><br><span class="line">            return Task.FromResult(new List&lt;ProductDto&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>4、启动商品微服务</li>
</ul>
<blockquote>
<p>进入YDT_ProductService项目目录中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>

<h3 id="3-2、电商网站准备"><a href="#3-2、电商网站准备" class="headerlink" title="3.2、电商网站准备"></a>3.2、电商网站准备</h3><ul>
<li>1、创建首页控制器</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中的Controllers目录中创建 IndexController控制器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 首页控制器（查询商品数据）</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;Index&quot;)]</span><br><span class="line">public class IndexController : AbpController</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取页面上的商品数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpGet]</span><br><span class="line">    public string GetProduct()</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;查询商品&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2、安装Volo.Abp.Http.Client</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中使用nuget安装Volo.Abp.Http.Client<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-34.png" alt="Alt text"></p>
</blockquote>
<ul>
<li>3、集成Volo.Abp.Http.Client</li>
</ul>
<blockquote>
<p>在YDT_WebSitesModule类上面集成</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule),</span><br><span class="line">    typeof(AbpHttpClientModule) // 集成Volo.Abp.Http.Client</span><br><span class="line">)]</span><br><span class="line">public class YDT_WebSitesModule : AbpModule</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>4、使用Volo.Abp.Http.Client</li>
</ul>
<blockquote>
<p>1、创建IProductService接口</p>
</blockquote>
<blockquote>
<p>从YDT_ProductService项目中，直接复制过来，然后放到Services目录下，同时把Dto目录也复制过来</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IProductService : ICrudAppService&lt;ProductDto,Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2、配置appsettings.json</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中的appsettings.json实现配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  /* 2、配置商品微服务地址*/</span><br><span class="line">  &quot;RemoteServices&quot;: &#123;</span><br><span class="line">    &quot;ProductService&quot;: &#123;</span><br><span class="line">      &quot;BaseUrl&quot;: &quot;http://localhost:44376&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3、配置YDT_WebSitesModule</li>
</ul>
<blockquote>
<p>在YDT_WebSites项目中的YDT_WebSitesModule类中实现配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using Volo.Abp.Http.Client;</span><br><span class="line"></span><br><span class="line">namespace YDT_WebSites;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule),</span><br><span class="line">    typeof(AbpHttpClientModule)</span><br><span class="line">)]</span><br><span class="line">public class YDT_WebSitesModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var hostingEnvironment = context.Services.GetHostingEnvironment();</span><br><span class="line">        var configuration = context.Services.GetConfiguration();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ConfigureUrls(configuration);</span><br><span class="line">        ConfigureAutoMapper(context);</span><br><span class="line">        ConfigureSwagger(context.Services, configuration);</span><br><span class="line">        ConfigureAutoApiControllers();</span><br><span class="line">        ConfigureVirtualFiles(hostingEnvironment);</span><br><span class="line">        ConfigureLocalization();</span><br><span class="line">        ConfigureCors(context, configuration);</span><br><span class="line">        ConfigureDataProtection(context);</span><br><span class="line">        ConfigureEfCore(context);</span><br><span class="line"></span><br><span class="line">        // 1、加载IProductService（配置商品微服务）</span><br><span class="line">        context.Services.AddHttpClientProxies(</span><br><span class="line">            typeof(YDT_WebSitesModule).Assembly, // 1、使用程序集加载</span><br><span class="line">            &quot;ProductService&quot; // 2、指定微服务名称</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>5、启动电商网站</li>
</ul>
<blockquote>
<p>进入YDT_WebSites项目目录中。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>
<ul>
<li>4、微服务通信缺陷<blockquote>
<p>缺陷：如果商品微服务启动多个实例，形成集群，那么电商网站无法实现访问。</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>方案：需要使用API网关</p>
</blockquote>
<ul>
<li><p>5、API网关</p>
<blockquote>
<p>含义：API网关是为了解决微服务之间通信，主要是为了解决集群间通信。同时屏蔽通信，网站和各个微服务之间独立发展。</p>
</blockquote>
</li>
<li><p>6、API网关应用场景<br>  电商网站调用商品微服务。<br><br>  通信流程：电商网站（首页控制器）——商品微服务（商品控制器）<br><br>  问题：商品微服务启动多个实例，形成集群，电商网站无法通信<br><br>  工具：使用API网关<br><br>  方案：电商网站（首页控制器）——-API网关——商品微服务（商品控制器）</p>
</li>
<li><p>7、API网关落地</p>
<blockquote>
<p>含义：电商网站调用API网关，API网关调用商品微服务<br>技术：Ocelot</p>
</blockquote>
</li>
<li><p>7.1、API网关项目准备</p>
<blockquote>
<p>1、API网关项目<br>在YDT_MicroService解决方案中创建 YDT_Gateway API网关项目</p>
</blockquote>
</li>
</ul>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-35.png" alt="Alt text"></p>
<blockquote>
<p>2、安装Ocelot<br>在YDT_Gateway项目中安装Ocelot</p>
</blockquote>
<p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-36.png" alt="Alt text"></p>
<blockquote>
<p>3、集成Ocelot<br>在YDT_Gateway项目中安装Ocelot</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_Gateway.Data;</span><br><span class="line">using YDT_Gateway.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using Ocelot.DependencyInjection;</span><br><span class="line">using Ocelot.Middleware;</span><br><span class="line"></span><br><span class="line">namespace YDT_Gateway;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule)</span><br><span class="line"></span><br><span class="line">)]</span><br><span class="line">public class YDT_GatewayModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var hostingEnvironment = context.Services.GetHostingEnvironment();</span><br><span class="line">        var configuration = context.Services.GetConfiguration();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ConfigureUrls(configuration);</span><br><span class="line">        ConfigureAutoMapper(context);</span><br><span class="line">        ConfigureSwagger(context.Services, configuration);</span><br><span class="line">        ConfigureAutoApiControllers();</span><br><span class="line">        ConfigureVirtualFiles(hostingEnvironment);</span><br><span class="line">        ConfigureLocalization();</span><br><span class="line">        ConfigureCors(context, configuration);</span><br><span class="line">        ConfigureDataProtection(context);</span><br><span class="line">        ConfigureEfCore(context);</span><br><span class="line"></span><br><span class="line">        // 1、集成Ocelot</span><br><span class="line">        context.Services.AddOcelot(context.Services.GetConfiguration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnApplicationInitialization(ApplicationInitializationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var app = context.GetApplicationBuilder();</span><br><span class="line">        var env = context.GetEnvironment();</span><br><span class="line"></span><br><span class="line">        if (env.IsDevelopment())</span><br><span class="line">        &#123;</span><br><span class="line">            app.UseDeveloperExceptionPage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.UseAbpRequestLocalization();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        app.UseCorrelationId();</span><br><span class="line">        app.UseStaticFiles();</span><br><span class="line">        app.UseRouting();</span><br><span class="line">        app.UseCors();</span><br><span class="line">        app.UseAuthentication();</span><br><span class="line">        app.UseUnitOfWork();</span><br><span class="line">        app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line">        app.UseAbpSwaggerUI(options =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            options.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;YDT_Gateway API&quot;);</span><br><span class="line"></span><br><span class="line">            var configuration = context.GetConfiguration();</span><br><span class="line">            options.OAuthClientId(configuration[&quot;AuthServer:SwaggerClientId&quot;]);</span><br><span class="line">            options.OAuthScopes(&quot;YDT_Gateway&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseAuditing();</span><br><span class="line">        app.UseAbpSerilogEnrichers();</span><br><span class="line">		app.UseConfiguredEndpoints();</span><br><span class="line">       </span><br><span class="line">        //  2、集成Ocelot</span><br><span class="line">        app.UseOcelot().Wait();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4、使用Ocelot<br>​1、创建IProductService接口<br>从YDT_ProductService项目中直接复制过来IProductService接口和Dto</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IProductService : ICrudAppService&lt;ProductDto,Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public Task&lt;List&lt;ProductDto&gt;&gt; GetProductsAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、配置appsettings.json<br>在YDT_Gateway项目中的appsettings.json文件中实现配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   .....</span><br><span class="line">  &quot;Routes&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;UpstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;UpstreamHttpMethod&quot;: [ &quot;Put&quot;, &quot;Delete&quot;, &quot;Get&quot;, &quot;Post&quot; ],</span><br><span class="line">      &quot;DownstreamPathTemplate&quot;: &quot;/api/app/product/&#123;everything&#125;&quot;,</span><br><span class="line">      &quot;DownstreamScheme&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;DownstreamHostAndPorts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">          &quot;Port&quot;: 44376</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;Host&quot;: &quot;localhost&quot;,</span><br><span class="line">          &quot;Port&quot;: 44377</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;LoadBalancerOptions&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;RoundRobin&quot; /**LeastConnection*/</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、配置YDT_GatewayModule<br>在YDT_Gateway项目中的YDT_GatewayModule文件中实现配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Cors;</span><br><span class="line">using Microsoft.AspNetCore.DataProtection;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection.Extensions;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using YDT_Gateway.Data;</span><br><span class="line">using YDT_Gateway.Localization;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Uow;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc.Localization;</span><br><span class="line">using Volo.Abp.AspNetCore.Serilog;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.MySQL;</span><br><span class="line">using Volo.Abp.Localization;</span><br><span class="line">using Volo.Abp.Localization.ExceptionHandling;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line">using Volo.Abp.Swashbuckle;</span><br><span class="line">using Volo.Abp.UI.Navigation.Urls;</span><br><span class="line">using Volo.Abp.Validation.Localization;</span><br><span class="line">using Volo.Abp.VirtualFileSystem;</span><br><span class="line">using Ocelot.DependencyInjection;</span><br><span class="line">using Ocelot.Middleware;</span><br><span class="line"></span><br><span class="line">namespace YDT_Gateway;</span><br><span class="line"></span><br><span class="line">[DependsOn(</span><br><span class="line">    // ABP Framework packages</span><br><span class="line">    typeof(AbpAspNetCoreMvcModule),</span><br><span class="line">    typeof(AbpAutofacModule),</span><br><span class="line">    typeof(AbpAutoMapperModule),</span><br><span class="line">    typeof(AbpEntityFrameworkCoreMySQLModule),</span><br><span class="line">    typeof(AbpSwashbuckleModule),</span><br><span class="line">    typeof(AbpAspNetCoreSerilogModule)</span><br><span class="line"></span><br><span class="line">)]</span><br><span class="line">public class YDT_GatewayModule : AbpModule</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var hostingEnvironment = context.Services.GetHostingEnvironment();</span><br><span class="line">        var configuration = context.Services.GetConfiguration();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ConfigureUrls(configuration);</span><br><span class="line">        ConfigureAutoMapper(context);</span><br><span class="line">        ConfigureSwagger(context.Services, configuration);</span><br><span class="line">        ConfigureAutoApiControllers();</span><br><span class="line">        ConfigureVirtualFiles(hostingEnvironment);</span><br><span class="line">        ConfigureLocalization();</span><br><span class="line">        ConfigureCors(context, configuration);</span><br><span class="line">        ConfigureDataProtection(context);</span><br><span class="line">        ConfigureEfCore(context);</span><br><span class="line"></span><br><span class="line">        // 1、集成Ocelot</span><br><span class="line">        context.Services.AddOcelot(context.Services.GetConfiguration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public override void OnApplicationInitialization(ApplicationInitializationContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var app = context.GetApplicationBuilder();</span><br><span class="line">        var env = context.GetEnvironment();</span><br><span class="line"></span><br><span class="line">        if (env.IsDevelopment())</span><br><span class="line">        &#123;</span><br><span class="line">            app.UseDeveloperExceptionPage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.UseAbpRequestLocalization();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        app.UseCorrelationId();</span><br><span class="line">        app.UseStaticFiles();</span><br><span class="line">        app.UseRouting();</span><br><span class="line">        app.UseCors();</span><br><span class="line">        app.UseAuthentication();</span><br><span class="line">        app.UseUnitOfWork();</span><br><span class="line">        app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">        app.UseSwagger();</span><br><span class="line">        app.UseAbpSwaggerUI(options =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            options.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;YDT_Gateway API&quot;);</span><br><span class="line"></span><br><span class="line">            var configuration = context.GetConfiguration();</span><br><span class="line">            options.OAuthClientId(configuration[&quot;AuthServer:SwaggerClientId&quot;]);</span><br><span class="line">            options.OAuthScopes(&quot;YDT_Gateway&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        app.UseAuditing();</span><br><span class="line">        app.UseAbpSerilogEnrichers();</span><br><span class="line">		//app.UseConfiguredEndpoints();</span><br><span class="line">		// 3、配置app.MapWhen（目的：是为了能够让电商网站访问）</span><br><span class="line">        app.MapWhen(</span><br><span class="line">             ctx =&gt;</span><br><span class="line">                 ctx.Request.Path.ToString().StartsWith(&quot;/api/abp/&quot;) ||</span><br><span class="line">                 ctx.Request.Path.ToString().StartsWith(&quot;/Abp/&quot;) ||</span><br><span class="line">                 ctx.Request.Path.ToString().StartsWith(&quot;/swagger/&quot;),</span><br><span class="line">             app2 =&gt;</span><br><span class="line">             &#123;</span><br><span class="line">                 app2.UseRouting();</span><br><span class="line">                 app2.UseConfiguredEndpoints();</span><br><span class="line">             &#125;</span><br><span class="line">         );</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">        //  2、集成Ocelot</span><br><span class="line">        app.UseOcelot().Wait();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>7.1、API网关项目准备<br>1、修改appsettings.json<br>在YDT_WebSites项目修改appsettings.json文件中RemoteServices配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ....</span><br><span class="line">  /* 2、配置商品微服务地址*/</span><br><span class="line">  &quot;RemoteServices&quot;: &#123;</span><br><span class="line">    &quot;ProductService&quot;: &#123;</span><br><span class="line">      &quot;BaseUrl&quot;: &quot;http://localhost:44368&quot; /* 修改成YDT_Gateway项目端口*/</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/02/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/2%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%90%BD%E5%9C%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/02/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/2%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%90%BD%E5%9C%B0/" class="post-title-link" itemprop="url">2、千万级秒杀项目实战落地</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-02 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-02T10:48:57+08:00">2023-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-19 16:40:53" itemprop="dateModified" datetime="2024-02-19T16:40:53+08:00">2024-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/02/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/2%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%90%BD%E5%9C%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/02/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/2%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%90%BD%E5%9C%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="秒杀项目落地"><a href="#秒杀项目落地" class="headerlink" title="秒杀项目落地"></a>秒杀项目落地</h1><h2 id="落地技术平台"><a href="#落地技术平台" class="headerlink" title="落地技术平台"></a>落地技术平台</h2><p>1、windows 10</p>
<p>2、Linux centos 7.6</p>
<h2 id="落地技术前提"><a href="#落地技术前提" class="headerlink" title="落地技术前提"></a>落地技术前提</h2><p>1、.Net5：.Netcore新的版本，主要以.Net5为主</p>
<p>2、DDD ：领域驱动设计思想</p>
<p>3、Abp vNext：基于.Net5开发的微服务框架</p>
<p>4、MySQL5.7：数据存储</p>
<h2 id="落地技术工具"><a href="#落地技术工具" class="headerlink" title="落地技术工具"></a>落地技术工具</h2><p>1、ABP CLI</p>
<p>2、VS2019</p>
<h2 id="如何创建微服务电商项目"><a href="#如何创建微服务电商项目" class="headerlink" title="如何创建微服务电商项目"></a>如何创建微服务电商项目</h2><p>微服务电商项目如图所示<br><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image.png" alt="Alt text"></p>
<h3 id="微服务电商项目创建"><a href="#微服务电商项目创建" class="headerlink" title="微服务电商项目创建"></a>微服务电商项目创建</h3><p>对于以上的电商微服务，应该如何创建，创建思路如下。</p>
<h3 id="创建微服务解决方案"><a href="#创建微服务解决方案" class="headerlink" title="创建微服务解决方案"></a>创建微服务解决方案</h3><p>1、先创建YDT.Products文件夹</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-1.png" alt="Alt text"></p>
<p>2、然后在YDT.Products文件夹中创建解决方案YDT.Microservices</p>
<p>​ 2.1、输入命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abp new YDT.SeckillProject -t console -o YDT.SeckillProject -v 4.4.3</span><br></pre></td></tr></table></figure>

<p>​ 命令如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-2.png" alt="Alt text"></p>
<p>​ 2.2、结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-3.png" alt="Alt text"></p>
<h3 id="创建微服务订单模块"><a href="#创建微服务订单模块" class="headerlink" title="创建微服务订单模块"></a>创建微服务订单模块</h3><p>1、先进在YDT.Microservices解决方案文件夹中创建YDT.Order模块</p>
<p>​ 1.1、输入命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abp new YDT.Order -t module –dbms mysql –no-ui -o moduls\YDT.Order -v 4.4.3</span><br></pre></td></tr></table></figure>

<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-4.png" alt="Alt text"></p>
<p>​ 2.2、结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-5.png" alt="Alt text"></p>
<p>创建微服务商品模块<br>1、先进在YDT.Microservices解决方案文件夹中创建YDT.Product模块</p>
<p>​ 1.1、输入命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abp new YDT.Product -t module –no-ui –dbms mysql -o moduls\YDT.Product -v 4.4.3</span><br></pre></td></tr></table></figure>
<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-6.png" alt="Alt text"></p>
<p>​ 2.2、结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-7.png" alt="Alt text"></p>
<p>创建微服务支付模块<br>1、先进在YDT.Microservices解决方案文件夹中创建YDT.Payment模块</p>
<p>​ 1.1、输入命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abp new YDT.Payment -t module –no-ui –dbms mysql -o moduls\YDT.Payment -v 4.4.3</span><br></pre></td></tr></table></figure>
<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-8.png" alt="Alt text"></p>
<p>​ 2.2、结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-9.png" alt="Alt text"></p>
<p>创建微服务用户模块<br>1、先在YDT.Microservices解决方案文件夹中创建YDT.User模块</p>
<p>​ 1.1、输入命令:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abp new YDT.User -t module –no-ui –dbms mysql -o moduls\YDT.User -v 4.4.3</span><br></pre></td></tr></table></figure>
<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-10.png" alt="Alt text"></p>
<p>​ 2.2、结果如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-11.png" alt="Alt text"></p>
<h3 id="电商微服务层创建"><a href="#电商微服务层创建" class="headerlink" title="电商微服务层创建"></a>电商微服务层创建</h3><p>1、先在YDT.Microservices解决方案文件夹中创建microservices文件夹</p>
<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-12.png" alt="Alt text"></p>
<p>2、然后在microservices文件夹中引入订单，商品，支付，用户4个模块中Host项目中</p>
<p>YDT.Order.HttpApi.Host</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-13.png" alt="Alt text"></p>
<p>YDT.Payment.HttpApi.Host</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-14.png" alt="Alt text"></p>
<p>YDT.Product.HttpApi.Host</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-15.png" alt="Alt text"></p>
<p>YDT.User.HttpApi.Host</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-16.png" alt="Alt text"></p>
<p>结果如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-17.png" alt="Alt text"></p>
<h3 id="电商微服务聚合层创建"><a href="#电商微服务聚合层创建" class="headerlink" title="电商微服务聚合层创建"></a>电商微服务聚合层创建</h3><p>​ 1、先在YDT.Microservices解决方案文件夹中创建aggregateservices文件夹</p>
<p>​ 命令如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-18.png" alt="Alt text"></p>
<h2 id="如何引入微服务电商项目"><a href="#如何引入微服务电商项目" class="headerlink" title="如何引入微服务电商项目"></a>如何引入微服务电商项目</h2><h3 id="模块层引入"><a href="#模块层引入" class="headerlink" title="模块层引入"></a>模块层引入</h3><p>1、先使用VS2019引入YDT.Microservices项目</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-19.png" alt="Alt text"></p>
<p>2、然后创建moduls文件夹</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-20.png" alt="Alt text"></p>
<p>​ 2.1、在moduls中创建订单，商品，支付，用户解决方案文件夹</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-21.png" alt="Alt text"></p>
<p>​ 2.2、然后在YDT.Order、YDT.Product、YDT.Payment、YDT.User解决方案文件夹中引入项目</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-22.png" alt="Alt text"></p>
<h3 id="微服务层引入"><a href="#微服务层引入" class="headerlink" title="微服务层引入"></a>微服务层引入</h3><p>1、先创建microservices解决方案文件夹</p>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-23.png" alt="Alt text"></p>
<p>2、然后在microservices解决方案文件夹中引入项目</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-24.png" alt="Alt text"></p>
<h3 id="微服务聚合层引入"><a href="#微服务聚合层引入" class="headerlink" title="微服务聚合层引入"></a>微服务聚合层引入</h3><p>1、先创建aggregateservices解决方案文件夹</p>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-25.png" alt="Alt text"></p>
<h2 id="订单微服务落地"><a href="#订单微服务落地" class="headerlink" title="订单微服务落地"></a>订单微服务落地</h2><h3 id="订单微服务前提"><a href="#订单微服务前提" class="headerlink" title="订单微服务前提"></a>订单微服务前提</h3><h4 id="订单微服务修改"><a href="#订单微服务修改" class="headerlink" title="订单微服务修改"></a>订单微服务修改</h4><p>1、先在YDT.Order.HttpApi.Host项目中重新项目依赖</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-26.png" alt="Alt text"></p>
<p>​ 1.1、重新引入后结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-27.png" alt="Alt text"></p>
<p>​ 2、然后在YDT.Order.HttpApi.Host项目中移除项目</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-28.png" alt="Alt text"></p>
<p>2.1、在OrderHttpApiHostModule类中删除引用</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-29.png" alt="Alt text"></p>
<p>2.2、然后在YDT.Order.HttpApi.Host项目中引入</p>
<p>Volo.Abp.EntityFrameworkCore.MySQL,</p>
<p>Microsoft.EntityFrameworkCore.Tools</p>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-30.png" alt="Alt text"></p>
<p>​ 3、然后在OrderHttpApiHostModule类中修改为</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-31.png" alt="Alt text"></p>
<p>​ 3.1、修改后结果如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-32.png" alt="Alt text"></p>
<p>​ 4、然后在OrderHttpApiHostMigrationsDbContextFactory类中修改为</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-33.png" alt="Alt text"></p>
<p>​ 4.1、修改后结果如图所示：</p>
<p>var builder &#x3D; new DbContextOptionsBuilder ()<br>.UseMySql(configuration.GetConnectionString(“Order”), MySqlServerVersion.LatestSupportedServerVersion);</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-34.png" alt="Alt text"></p>
<p>​ 5、然后在OrderHttpApiHostMigrationsDbContextFactory类中修改为</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-35.png" alt="Alt text"></p>
<p>​ 5.1、修改后结果如图所示：</p>
<p>“ConnectionStrings”: {<br>“Default”: “Server&#x3D;localhost;Port&#x3D;3306;Database&#x3D;YDT.OrderService;Uid&#x3D;root;Pwd&#x3D;root;”,<br>“Order”: “Server&#x3D;localhost;Port&#x3D;3306;Database&#x3D;YDT.OrderService;Uid&#x3D;root;Pwd&#x3D;root;”<br>},</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-36.png" alt="Alt text"></p>
<h3 id="订单微服务迁移"><a href="#订单微服务迁移" class="headerlink" title="订单微服务迁移"></a>订单微服务迁移</h3><p>1、先进入YDT.Order.HttpApi.Host项目控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add orderservice</span><br></pre></td></tr></table></figure>

<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-38.png" alt="Alt text"></p>
<p>​ 1.1、迁移文件如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-39.png" alt="Alt text"></p>
<p>2、然后进入YDT.Order.HttpApi.Host项目控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure>

<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-40.png" alt="Alt text"></p>
<p>3、MySQL数据库结果如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-41.png" alt="Alt text"></p>
<h4 id="订单微服务启动"><a href="#订单微服务启动" class="headerlink" title="订单微服务启动"></a>订单微服务启动</h4><p>1、先进入YDT.Order.HttpApi.Host项目控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-42.png" alt="Alt text"></p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-43.png" alt="Alt text"></p>
<h3 id="订单微服务访问"><a href="#订单微服务访问" class="headerlink" title="订单微服务访问"></a>订单微服务访问</h3><p>1、先进入浏览器</p>
<p>​ 输入地址：<a target="_blank" rel="noopener" href="https://localhost:44389/">https://localhost:44389</a></p>
<p>2、访问结果如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-44.png" alt="Alt text"></p>
<h2 id="创建订单业务场景落地"><a href="#创建订单业务场景落地" class="headerlink" title="创建订单业务场景落地"></a>创建订单业务场景落地</h2><h3 id="订单微服务结构"><a href="#订单微服务结构" class="headerlink" title="订单微服务结构"></a>订单微服务结构</h3><p>订单微服务目前结构，如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-45.png" alt="Alt text"></p>
<p>YDT.Order.Domain修改<br>1、先进入到YDT.Order.Domain中，创建文件夹Orders，并增加Orders，OrderItem，IOrderRepository类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-46.png" alt="Alt text"></p>
<p>2、然后在Orders类中增加代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Collections.ObjectModel;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Domain.Entities;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.OrderServices.Models</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单模型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class Orders : AggregateRoot&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        //[Key]</span><br><span class="line">      //  public int Id &#123; set; get; &#125; // 主键</span><br><span class="line">        public string OrderType &#123; set; get; &#125; // 订单类型</span><br><span class="line">       // public string OrderFlag &#123; set; get; &#125; // 订单标志</span><br><span class="line">        public Guid UserId &#123; set; get; &#125; // 用户Id</span><br><span class="line">        public string OrderSn &#123; set; get; &#125;// 订单号</span><br><span class="line">        public string OrderTotalPrice &#123; set; get; &#125; // 订单总价</span><br><span class="line">        public DateTime Createtime &#123; set; get; &#125; // 创建时间</span><br><span class="line">        public DateTime Updatetime &#123; set; get; &#125; // 更新时间</span><br><span class="line">        public DateTime Paytime &#123; set; get; &#125;// 支付时间</span><br><span class="line">        public DateTime Sendtime &#123; set; get; &#125;// 发货时间</span><br><span class="line">        public DateTime Successtime &#123; set; get; &#125;// 订单完成时间</span><br><span class="line">        public int OrderStatus &#123; set; get; &#125; // 订单状态</span><br><span class="line">        public string OrderName &#123; set; get; &#125; // 订单名称</span><br><span class="line">        public string OrderTel &#123; set; get; &#125; // 订单电话</span><br><span class="line">        public string OrderAddress &#123; set; get; &#125; // 订单地址</span><br><span class="line">        public string OrderRemark &#123; set; get; &#125;// 订单备注</span><br><span class="line"></span><br><span class="line">        // 订单项</span><br><span class="line">        public ICollection&lt;OrderItem&gt; OrderItems &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public Orders()</span><br><span class="line">        &#123;</span><br><span class="line">            OrderItems = new Collection&lt;OrderItem&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Orders(Guid id) : base(id)</span><br><span class="line">        &#123;</span><br><span class="line">            OrderItems = new Collection&lt;OrderItem&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 添加订单项</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public void AddOrderItem(Guid itemId, string OrderSn, string ProductName, decimal ItemPrice)</span><br><span class="line">        &#123;</span><br><span class="line">            // 1、创建一个商品图片</span><br><span class="line">            OrderItem orderItem = new OrderItem(itemId);</span><br><span class="line">            orderItem.OrderSn = OrderSn;</span><br><span class="line">            orderItem.ProductName = ProductName;</span><br><span class="line">            orderItem.ItemPrice = ItemPrice;</span><br><span class="line"></span><br><span class="line">            // 2、添加到集合中</span><br><span class="line">            OrderItems.Add(orderItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、然后在OrderItem类中增加代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Domain.Entities;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.OrderServices.Models</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单项(记录购买商品信息)</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class OrderItem : Entity&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        //[Key]</span><br><span class="line">       // public int Id &#123; set; get; &#125; // 主键</span><br><span class="line">        public Guid OrderId &#123; set; get; &#125; // 订单编号</span><br><span class="line">        public string OrderSn &#123; set; get; &#125; // 订单号</span><br><span class="line">        public Guid ProductId &#123; set; get; &#125; // 商品编号</span><br><span class="line">        public string ProductUrl &#123; set; get; &#125; // 商品主图</span><br><span class="line">        public string ProductName &#123; set; get; &#125;// 商品名称</span><br><span class="line">        public decimal ItemPrice &#123; set; get; &#125;  // 订单项单价</span><br><span class="line">        public int ItemCount &#123; set; get; &#125; // 订单项数量</span><br><span class="line">        public decimal ItemTotalPrice &#123; set; get; &#125; // 订单项总价</span><br><span class="line"></span><br><span class="line">        public OrderItem()</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public OrderItem(Guid id) : base(id)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、然后在IOrderRepository类中增加代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line">namespace Acme.BookStore.Authors</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单仓储</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IOrderRepository : IRepository&lt;Orders, Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YDT.Order.EntityFrameworkCore修改<br>1、先进入到YDT.Order.EntityFrameworkCore中，创建文件夹Orders，并创建OrderRepository类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-47.png" alt="Alt text"></p>
<p>2、然后在OrderRepository类中增加代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">using Acme.BookStore.Authors;</span><br><span class="line">using Microsoft.EntityFrameworkCore;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Linq.Expressions;</span><br><span class="line">using System.Threading;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line">using Volo.Abp.Domain.Repositories.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.Linq;</span><br><span class="line">using YDT.Order.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.MicroService.ProductService.Repositories</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品仓储实现</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [Dependency(ServiceLifetime.Transient)]</span><br><span class="line">    public class OrderRepository : EfCoreRepository&lt;OrderDbContext, Orders, Guid&gt;, IOrderRepository</span><br><span class="line">    &#123;</span><br><span class="line">        public OrderRepository(</span><br><span class="line">            IDbContextProvider&lt;OrderDbContext&gt; dbContextProvider)</span><br><span class="line">            : base(dbContextProvider)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override async Task&lt;Orders&gt; GetAsync(Guid id, bool includeDetails = true, CancellationToken cancellationToken = default)</span><br><span class="line">        &#123;</span><br><span class="line">            DbSet&lt;Orders&gt; orders = await GetDbSetAsync();</span><br><span class="line">            return orders.Include(o =&gt; o.OrderItems).Where(o =&gt; o.Id == id).FirstOrDefault();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、然后进入到EntityFrameworkCore文件夹中，修改OrderDbContext类，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.EntityFrameworkCore;</span><br><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line">using Volo.Abp.Data;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line">namespace YDT.Order.EntityFrameworkCore</span><br><span class="line">&#123;</span><br><span class="line">    [ConnectionStringName(OrderDbProperties.ConnectionStringName)]</span><br><span class="line">    public class OrderDbContext : AbpDbContext&lt;OrderDbContext&gt;, IOrderDbContext</span><br><span class="line">    &#123;</span><br><span class="line">        /* Add DbSet for each Aggregate Root here. Example:</span><br><span class="line">         * public DbSet&lt;Question&gt; Questions &#123; get; set; &#125;</span><br><span class="line">         */</span><br><span class="line">        public DbSet&lt;Orders&gt; Orders &#123; get; set; &#125; // 配置订单领域(以领域为单位)</span><br><span class="line">        public OrderDbContext(DbContextOptions&lt;OrderDbContext&gt; options) </span><br><span class="line">            : base(options)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protected override void OnModelCreating(ModelBuilder builder)</span><br><span class="line">        &#123;</span><br><span class="line">            base.OnModelCreating(builder);</span><br><span class="line"></span><br><span class="line">            builder.ConfigureOrder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、然后进入到EntityFrameworkCore文件夹中，修改OrderDbContextModelCreatingExtensions类，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using Microsoft.EntityFrameworkCore;</span><br><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore.Modeling;</span><br><span class="line"></span><br><span class="line">namespace YDT.Order.EntityFrameworkCore</span><br><span class="line">&#123;</span><br><span class="line">    public static class OrderDbContextModelCreatingExtensions</span><br><span class="line">    &#123;</span><br><span class="line">        public static void ConfigureOrder(</span><br><span class="line">            this ModelBuilder builder,</span><br><span class="line">            Action&lt;OrderModelBuilderConfigurationOptions&gt; optionsAction = null)</span><br><span class="line">        &#123;</span><br><span class="line">            Check.NotNull(builder, nameof(builder));</span><br><span class="line"></span><br><span class="line">            var options = new OrderModelBuilderConfigurationOptions(</span><br><span class="line">                OrderDbProperties.DbTablePrefix,</span><br><span class="line">                OrderDbProperties.DbSchema</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            optionsAction?.Invoke(options);</span><br><span class="line"></span><br><span class="line">            builder.Entity&lt;Orders&gt;(b =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                b.ConfigureByConvention();</span><br><span class="line">                b.HasMany(u =&gt; u.OrderItems).WithOne().HasForeignKey(ur =&gt; ur.OrderId).IsRequired();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            /* Configure all entities here. Example:</span><br><span class="line"></span><br><span class="line">            builder.Entity&lt;Question&gt;(b =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                //Configure table &amp; schema name</span><br><span class="line">                b.ToTable(options.TablePrefix + &quot;Questions&quot;, options.Schema);</span><br><span class="line">            </span><br><span class="line">                b.ConfigureByConvention();</span><br><span class="line">            </span><br><span class="line">                //Properties</span><br><span class="line">                b.Property(q =&gt; q.Title).IsRequired().HasMaxLength(QuestionConsts.MaxTitleLength);</span><br><span class="line">                </span><br><span class="line">                //Relations</span><br><span class="line">                b.HasMany(question =&gt; question.Tags).WithOne().HasForeignKey(qt =&gt; qt.QuestionId);</span><br><span class="line"></span><br><span class="line">                //Indexes</span><br><span class="line">                b.HasIndex(q =&gt; q.CreationTime);</span><br><span class="line">            &#125;);</span><br><span class="line">            */</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YDT.Order.Application.Contracts修改<br>1、先进入到YDT.Order.Application.Contracts项目中，创建Orders文件夹，并创建IOrderAppService，CreateOrderDto，OrderDto，UpdateOrderDto类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-48.png" alt="Alt text"></p>
<p>2、然后在IOrderAppService类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">using Acme.BookStore.Authors;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.ProductServices.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单应用服务接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IOrderAppService : ICrudAppService&lt;</span><br><span class="line">                                            OrderDto, </span><br><span class="line">                                            Guid, </span><br><span class="line">                                            PagedAndSortedResultRequestDto,</span><br><span class="line">                                            CreateOrderDto,</span><br><span class="line">                                            UpdateOrderDto&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、然后在CreateOrderDto类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line">namespace Acme.BookStore.Authors</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 创建商品Dto</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class CreateOrderDto</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        public decimal OrderTotalPrice &#123; set; get; &#125; // 订单价格</span><br><span class="line"></span><br><span class="line">        public int ProductCount &#123; set; get; &#125;// 商品数量</span><br><span class="line"></span><br><span class="line">        public CreateOrderItemDto[] OrderItems &#123; set; get; &#125; // 商品图片集合</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class CreateOrderItemDto</span><br><span class="line">    &#123;</span><br><span class="line">        public Guid ProductId &#123; set; get; &#125; // 商品编号</span><br><span class="line">        public string ProductName &#123; set; get; &#125; // 商品名称</span><br><span class="line">       </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、然后在OrderDto类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line">namespace Acme.BookStore.Authors</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单Dto</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class OrderDto : EntityDto&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public string OrderType &#123; set; get; &#125; // 订单类型</span><br><span class="line">        public Guid UserId &#123; set; get; &#125; // 用户Id</span><br><span class="line">        public string OrderSn &#123; set; get; &#125;// 订单号</span><br><span class="line">        public string OrderTotalPrice &#123; set; get; &#125; // 订单总价</span><br><span class="line">        public DateTime Createtime &#123; set; get; &#125; // 创建时间</span><br><span class="line">        public DateTime Updatetime &#123; set; get; &#125; // 更新时间</span><br><span class="line">        public DateTime Paytime &#123; set; get; &#125;// 支付时间</span><br><span class="line">        public DateTime Sendtime &#123; set; get; &#125;// 发货时间</span><br><span class="line">        public DateTime Successtime &#123; set; get; &#125;// 订单完成时间</span><br><span class="line">        public int OrderStatus &#123; set; get; &#125; // 订单状态</span><br><span class="line">        public string OrderName &#123; set; get; &#125; // 订单名称</span><br><span class="line">        public string OrderTel &#123; set; get; &#125; // 订单电话</span><br><span class="line">        public string OrderAddress &#123; set; get; &#125; // 订单地址</span><br><span class="line">        public string OrderRemark &#123; set; get; &#125;// 订单备注</span><br><span class="line"></span><br><span class="line">        public OrderItemDto[] OrderItems &#123; set; get; &#125;// 订单项集合</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class OrderItemDto</span><br><span class="line">    &#123;</span><br><span class="line">        public Guid OrderId &#123; set; get; &#125; // 订单编号</span><br><span class="line">        public string OrderSn &#123; set; get; &#125; // 订单号</span><br><span class="line">        public Guid ProductId &#123; set; get; &#125; // 商品编号</span><br><span class="line">        public string ProductUrl &#123; set; get; &#125; // 商品主图</span><br><span class="line">        public string ProductName &#123; set; get; &#125;// 商品名称</span><br><span class="line">        public decimal ItemPrice &#123; set; get; &#125;  // 订单项单价</span><br><span class="line">        public int ItemCount &#123; set; get; &#125; // 订单项数量</span><br><span class="line">        public decimal ItemTotalPrice &#123; set; get; &#125; // 订单项总价</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、然后在UpdateOrderDto类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line">namespace Acme.BookStore.Authors</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 创建商品Dto</span><br><span class="line">    /// </span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class UpdateOrderDto</span><br><span class="line">    &#123;</span><br><span class="line">        public string ProductUrl &#123; set; get; &#125;         // 商品主图</span><br><span class="line">        public string ProductTitle &#123; set; get; &#125;       //商品标题</span><br><span class="line">        public string ProductDescription &#123; set; get; &#125;     // 图文描述</span><br><span class="line">        public decimal ProductVirtualprice &#123; set; get; &#125; //商品虚拟价格</span><br><span class="line">        public decimal ProductPrice &#123; set; get; &#125;       //价格</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YDT.Order.Application修改<br>1、先进入到YDT.Order.Application项目中，创建Orders文件夹，并创建OrderAppService类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-49.png" alt="Alt text"></p>
<p>2、然后在IOrderAppService类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">using Acme.BookStore.Authors;</span><br><span class="line">using AutoMapper;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Security.Claims;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.ProductServices.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单服务实现</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [RemoteService(IsEnabled = false)]</span><br><span class="line">    public class OrderAppService : CrudAppService&lt;</span><br><span class="line">                                            Orders,</span><br><span class="line">                                            OrderDto,</span><br><span class="line">                                            Guid,</span><br><span class="line">                                            PagedAndSortedResultRequestDto,</span><br><span class="line">                                            CreateOrderDto,</span><br><span class="line">                                            UpdateOrderDto&gt;,IOrderAppService</span><br><span class="line">    &#123;</span><br><span class="line">        public IOrderRepository _OrderRepository;</span><br><span class="line"></span><br><span class="line">        public OrderAppService(IOrderRepository repository)</span><br><span class="line">            : base(repository)</span><br><span class="line">        &#123;</span><br><span class="line">            this._OrderRepository = repository;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、然后修改OrderApplicationAutoMapperProfile类中代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">using Acme.BookStore.Authors;</span><br><span class="line">using AutoMapper;</span><br><span class="line">using RuanMou.Projects.OrderServices.Models;</span><br><span class="line"></span><br><span class="line">namespace YDT.Order</span><br><span class="line">&#123;</span><br><span class="line">    public class OrderApplicationAutoMapperProfile : Profile</span><br><span class="line">    &#123;</span><br><span class="line">        public OrderApplicationAutoMapperProfile()</span><br><span class="line">        &#123;</span><br><span class="line">            /* You can configure your AutoMapper mapping configuration here.</span><br><span class="line">             * Alternatively, you can split your mapping configurations</span><br><span class="line">             * into multiple profile classes for a better organization. */</span><br><span class="line"></span><br><span class="line">            CreateMap&lt;Orders, OrderDto&gt;();</span><br><span class="line">            CreateMap&lt;OrderItem, OrderItemDto&gt;();</span><br><span class="line"></span><br><span class="line">            CreateMap&lt;CreateOrderDto, Orders&gt;();</span><br><span class="line">            CreateMap&lt;CreateOrderItemDto, OrderItem&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、然后修改OrderApplicationModule类中代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line">using Volo.Abp.AutoMapper;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using Volo.Abp.Application;</span><br><span class="line"></span><br><span class="line">namespace YDT.Order</span><br><span class="line">&#123;</span><br><span class="line">    [DependsOn(</span><br><span class="line">        typeof(OrderDomainModule),</span><br><span class="line">        typeof(OrderApplicationContractsModule),</span><br><span class="line">        typeof(AbpDddApplicationModule),</span><br><span class="line">        typeof(AbpAutoMapperModule)</span><br><span class="line">        )]</span><br><span class="line">    public class OrderApplicationModule : AbpModule</span><br><span class="line">    &#123;</span><br><span class="line">        public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            context.Services.AddAutoMapperObjectMapper&lt;OrderApplicationModule&gt;();</span><br><span class="line">            Configure&lt;AbpAutoMapperOptions&gt;(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.AddMaps&lt;OrderApplicationModule&gt;(validate: false);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YDT.Order.HttpApi修改<br>1、先进入到YDT.Order.HttpApi项目中，创建Orders文件夹，并创建OrdersController类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-50.png" alt="Alt text"></p>
<p>2、然后在OrdersController类中增加代码，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Acme.BookStore.Authors;</span><br><span class="line">using Microsoft.AspNetCore.Authorization;</span><br><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using RuanMou.Projects.ProductServices.Services;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT.Order.Samples</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 订单控制器</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [RemoteService]</span><br><span class="line">    [Route(&quot;api/OrderService/order&quot;)]</span><br><span class="line">    public class OrdersController : OrderController, IOrderAppService</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly IOrderAppService _OrderAppService;</span><br><span class="line"></span><br><span class="line">        public OrdersController(IOrderAppService OrderAppService)</span><br><span class="line">        &#123;</span><br><span class="line">            _OrderAppService = OrderAppService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [HttpGet(&quot;&#123;id&#125;&quot;)]</span><br><span class="line">        public async Task&lt;OrderDto&gt; GetAsync(Guid id)</span><br><span class="line">        &#123;</span><br><span class="line">            return await _OrderAppService.GetAsync(id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [HttpPost]</span><br><span class="line">        public async Task&lt;OrderDto&gt; CreateAsync(CreateOrderDto input)</span><br><span class="line">        &#123;</span><br><span class="line">            return await _OrderAppService.CreateAsync(input);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [HttpGet(&quot;List&quot;)]</span><br><span class="line">        public async Task&lt;PagedResultDto&lt;OrderDto&gt;&gt; GetListAsync(PagedAndSortedResultRequestDto input)</span><br><span class="line">        &#123;</span><br><span class="line">            return await _OrderAppService.GetListAsync(input);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [HttpPut]</span><br><span class="line">        public async Task&lt;OrderDto&gt; UpdateAsync(Guid id, UpdateOrderDto input)</span><br><span class="line">        &#123;</span><br><span class="line">            return await _OrderAppService.UpdateAsync(id,input);</span><br><span class="line">        &#125;</span><br><span class="line">        [HttpDelete]</span><br><span class="line">        public async Task DeleteAsync(Guid id)</span><br><span class="line">        &#123;</span><br><span class="line">            await _OrderAppService.DeleteAsync(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YDT.Order.HttpApi.Host迁移<br>1、先进入YDT.Order.HttpApi.Host项目控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add orderservice</span><br></pre></td></tr></table></figure>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-51.png" alt="Alt text"></p>
<p>2、迁移生成的文件，如图所示</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-52.png" alt="Alt text"></p>
<p>3、然后进入YDT.Order.HttpApi.Host项目控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-53.png" alt="Alt text"></p>
<p>4、然后进入MySQL，订单表和订单项表，</p>
<p>​ 如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-54.png" alt="Alt text"></p>
<h3 id="订单微服务启动-1"><a href="#订单微服务启动-1" class="headerlink" title="订单微服务启动"></a>订单微服务启动</h3><p>1、先进入YDT.Order.HttpApi.Host项目CMD控制台</p>
<p>​ 输入命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet run</span><br></pre></td></tr></table></figure>

<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-55.png" alt="Alt text"></p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-56.png" alt="Alt text"></p>
<p>1、先进入YDT.Order.HttpApi.Host项目CMD控制台</p>
<h3 id="订单微服务访问-1"><a href="#订单微服务访问-1" class="headerlink" title="订单微服务访问"></a>订单微服务访问</h3><p>1、先进入浏览器</p>
<p>​ 输入地址：<a target="_blank" rel="noopener" href="https://localhost:44389/">https://localhost:44389</a></p>
<p>2、然后输入地址，访问结果</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-57.png" alt="Alt text"></p>
<h3 id="创建订单落地"><a href="#创建订单落地" class="headerlink" title="创建订单落地"></a>创建订单落地</h3><p>1、先进入Orders模块中订单创建接口</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-58.png" alt="Alt text"></p>
<p>2、然后点击Execute，创建订单结果，</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-59.png" alt="Alt text"></p>
<p>3、创建订单项结果，</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-60.png" alt="Alt text"></p>
<h2 id="商品微服务落地"><a href="#商品微服务落地" class="headerlink" title="商品微服务落地"></a>商品微服务落地</h2><p>思路同订单微服务，如上。</p>
<h2 id="支付微服务落地"><a href="#支付微服务落地" class="headerlink" title="支付微服务落地"></a>支付微服务落地</h2><p>思路同订单微服务，如上。</p>
<h2 id="用户微服务落地"><a href="#用户微服务落地" class="headerlink" title="用户微服务落地"></a>用户微服务落地</h2><p>思路同订单微服务，如上。</p>
<h2 id="订单详情聚合服务落地"><a href="#订单详情聚合服务落地" class="headerlink" title="订单详情聚合服务落地"></a>订单详情聚合服务落地</h2><h3 id="订单详情聚合服务创建"><a href="#订单详情聚合服务创建" class="headerlink" title="订单详情聚合服务创建"></a>订单详情聚合服务创建</h3><p>1、先在aggregateservices解决方案文件中，通过vs2019创建 .Net5项目YDT.OrderDetailsServices，</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-61.png" alt="Alt text"></p>
<p>2、然后在YDT.OrderDetailsServices项目中，引入Volo.Abp.AspNetCore.Mvc，Volo.Abp.Autofac程序集</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-62.png" alt="Alt text"></p>
<p>3、然后在YDT.OrderDetailsServices项目中，创建OrderDetailsServicesModule类</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-63.png" alt="Alt text"></p>
<p>4、然后在OrderDetailsServicesModule类中添加代码，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Builder;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line">using Microsoft.Extensions.Hosting;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using Volo.Abp;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Autofac;</span><br><span class="line">using Volo.Abp.Modularity;</span><br><span class="line">using YDT.Order;</span><br><span class="line">using YDT.Product;</span><br><span class="line"></span><br><span class="line">namespace YDT.OrderDetailsServices</span><br><span class="line">&#123;</span><br><span class="line">    [DependsOn(typeof(AbpAspNetCoreMvcModule))]</span><br><span class="line">    [DependsOn(typeof(AbpAutofacModule))]</span><br><span class="line">    [DependsOn(typeof(OrderHttpApiClientModule))]</span><br><span class="line">    [DependsOn(typeof(ProductHttpApiClientModule))]</span><br><span class="line">    public class OrderDetailsServicesModule : AbpModule</span><br><span class="line">    &#123;</span><br><span class="line">        public override void ConfigureServices(ServiceConfigurationContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            context.Services.AddSwaggerGen(c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.SwaggerDoc(&quot;v1&quot;, new OpenApiInfo &#123; Title = &quot;YDT.OrderDetailsServices&quot;, Version = &quot;v1&quot; &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override void OnApplicationInitialization(ApplicationInitializationContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var app = context.GetApplicationBuilder();</span><br><span class="line">            var env = context.GetEnvironment();</span><br><span class="line"></span><br><span class="line">            // Configure the HTTP request pipeline.</span><br><span class="line">            if (env.IsDevelopment())</span><br><span class="line">            &#123;</span><br><span class="line">                app.UseExceptionHandler(&quot;/Error&quot;);</span><br><span class="line">                // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.</span><br><span class="line">                app.UseHsts();</span><br><span class="line"></span><br><span class="line">                app.UseDeveloperExceptionPage();</span><br><span class="line">                app.UseSwagger();</span><br><span class="line">                app.UseSwaggerUI(c =&gt; c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;YDT.OrderDetailsServices v1&quot;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.UseHttpsRedirection();</span><br><span class="line">            app.UseStaticFiles();</span><br><span class="line">            app.UseRouting();</span><br><span class="line">            app.UseConfiguredEndpoints();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、然后在Startup类中修改代码，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Builder;</span><br><span class="line">using Microsoft.AspNetCore.Hosting;</span><br><span class="line">using Microsoft.AspNetCore.HttpsPolicy;</span><br><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Microsoft.Extensions.Configuration;</span><br><span class="line">using Microsoft.Extensions.DependencyInjection;</span><br><span class="line">using Microsoft.Extensions.Hosting;</span><br><span class="line">using Microsoft.Extensions.Logging;</span><br><span class="line">using Microsoft.OpenApi.Models;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">namespace YDT.OrderDetailsServices</span><br><span class="line">&#123;</span><br><span class="line">    public class Startup</span><br><span class="line">    &#123;</span><br><span class="line">        public Startup(IConfiguration configuration)</span><br><span class="line">        &#123;</span><br><span class="line">            Configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public IConfiguration Configuration &#123; get; &#125;</span><br><span class="line"></span><br><span class="line">        public void ConfigureServices(IServiceCollection services)</span><br><span class="line">        &#123;</span><br><span class="line">            services.AddApplication&lt;OrderDetailsServicesModule&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void Configure(IApplicationBuilder app)</span><br><span class="line">        &#123;</span><br><span class="line">            app.InitializeApplication();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6、然后在Program类中修改代码，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Hosting;</span><br><span class="line">using Microsoft.Extensions.Configuration;</span><br><span class="line">using Microsoft.Extensions.Hosting;</span><br><span class="line">using Microsoft.Extensions.Logging;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">namespace YDT.OrderDetailsServices</span><br><span class="line">&#123;</span><br><span class="line">    public class Program</span><br><span class="line">    &#123;</span><br><span class="line">        public static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateHostBuilder(args).Build().Run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static IHostBuilder CreateHostBuilder(string[] args) =&gt;</span><br><span class="line">            Host.CreateDefaultBuilder(args)</span><br><span class="line">                .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">                &#125;)</span><br><span class="line">                .UseAutofac(); // 添加autofac</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="电商微服务落地"><a href="#电商微服务落地" class="headerlink" title="电商微服务落地"></a>电商微服务落地</h2><p>目前整个电商微服务目前结构状态</p>
<p>如图所示：</p>
<p><img src="/BlogPro/images%E5%8D%83%E4%B8%87/image-64.png" alt="Alt text"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/2%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/2%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">2、微服务-电商项目实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-02 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-02T10:48:57+08:00">2023-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-30 23:33:33" itemprop="dateModified" datetime="2024-01-30T23:33:33+08:00">2024-01-30</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/2%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/02/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/2%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="微服务-电商项目落地"><a href="#微服务-电商项目落地" class="headerlink" title="微服务-电商项目落地"></a>微服务-电商项目落地</h1><h3 id="1、环境平台"><a href="#1、环境平台" class="headerlink" title="1、环境平台"></a>1、环境平台</h3><pre><code>1、windows 10
2、Linux Centos7.6
3、Docker
4、k8s
</code></pre>
<h3 id="2、开发平台"><a href="#2、开发平台" class="headerlink" title="2、开发平台"></a>2、开发平台</h3><pre><code>1、.NET7
</code></pre>
<h3 id="3、框架"><a href="#3、框架" class="headerlink" title="3、框架"></a>3、框架</h3><pre><code>1、Abp vNext 7.3.0
</code></pre>
<h3 id="4、数据库"><a href="#4、数据库" class="headerlink" title="4、数据库"></a>4、数据库</h3><pre><code>2、MySQL 5.7
</code></pre>
<h3 id="5、工具"><a href="#5、工具" class="headerlink" title="5、工具"></a>5、工具</h3><pre><code>1、VS2022
</code></pre>
<h3 id="4、电商微服务模板"><a href="#4、电商微服务模板" class="headerlink" title="4、电商微服务模板"></a>4、电商微服务模板</h3><p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-30.png" alt="Alt text"></p>
<h3 id="4、创建解决方案"><a href="#4、创建解决方案" class="headerlink" title="4、创建解决方案"></a>4、创建解决方案</h3><pre><code>创建 解决方案是为了能够统一管微服务项目。
</code></pre>
<h3 id="1、创建工作目录"><a href="#1、创建工作目录" class="headerlink" title="1、创建工作目录"></a>1、创建工作目录</h3><pre><code>F:\work\.net_project\奕鼎通.NetP6架构2307班\第六章 微服务项目实战\微服务项目
</code></pre>
<h3 id="2、在工作目录中创建解决方案"><a href="#2、在工作目录中创建解决方案" class="headerlink" title="2、在工作目录中创建解决方案"></a>2、在工作目录中创建解决方案</h3><pre><code>abp new YDT_MicroService -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
<h3 id="3、导入解决方案"><a href="#3、导入解决方案" class="headerlink" title="3、导入解决方案"></a>3、导入解决方案</h3><pre><code>​ 将YDT_MicroService解决方案导入到VS2022中。
</code></pre>
<h1 id="5、创建微服务"><a href="#5、创建微服务" class="headerlink" title="5、创建微服务"></a>5、创建微服务</h1><h2 id="5-1、创建商品微服务"><a href="#5-1、创建商品微服务" class="headerlink" title="5.1、创建商品微服务"></a>5.1、创建商品微服务</h2><h3 id="1、创建商品微服务工作目录"><a href="#1、创建商品微服务工作目录" class="headerlink" title="1、创建商品微服务工作目录"></a>1、创建商品微服务工作目录</h3><ul>
<li>根据上文解决方案：进入YDT_MicroService解决方案目录中，然后在YDT_MicroService解决方案中，创建microservices目录<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F:\work\.net_project\奕鼎通.NetP6架构2307班\第六章 微服务项目实战\微服务项目\YDT_MicroServicesDemo\YDT_MicroService\microservice</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>然后进入microservice目录中，开始创建商品微服务</p>
</blockquote>
<h3 id="2、创建商品微服务"><a href="#2、创建商品微服务" class="headerlink" title="2、创建商品微服务"></a>2、创建商品微服务</h3><pre><code>abp new YDT_ProductService -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
<h3 id="3、导入商品微服务"><a href="#3、导入商品微服务" class="headerlink" title="3、导入商品微服务"></a>3、导入商品微服务</h3><p>​&gt; 将商品微服务导入到VS2022中</p>
<h3 id="4、修改商品微服务"><a href="#4、修改商品微服务" class="headerlink" title="4、修改商品微服务"></a>4、修改商品微服务</h3><blockquote>
<p>去掉ABP自带的应用模块，留下ABP框架部分</p>
</blockquote>
<h3 id="5、迁移商品微服务"><a href="#5、迁移商品微服务" class="headerlink" title="5、迁移商品微服务"></a>5、迁移商品微服务</h3><ul>
<li><p>1、创建商品模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Collections.ObjectModel;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Domain.Entities;</span><br><span class="line">using Volo.Abp.Domain.Entities.Auditing;</span><br><span class="line">using Volo.Abp.MultiTenancy;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.ProductServices.Models</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品模型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class Product :Entity&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        //public Guid Id &#123; set; get; &#125; // 商品主键</span><br><span class="line">        public string ProductCode &#123; set; get; &#125;    //商品编码</span><br><span class="line">        public string ProductUrl &#123; set; get; &#125;         // 商品主图</span><br><span class="line">        public string ProductTitle &#123; set; get; &#125;       //商品标题</span><br><span class="line">        public string ProductDescription &#123; set; get; &#125;     // 图文描述</span><br><span class="line">        public decimal ProductVirtualprice &#123; set; get; &#125; //商品虚拟价格</span><br><span class="line">        public decimal ProductPrice &#123; set; get; &#125;       //价格</span><br><span class="line">        public int ProductSort &#123; set; get; &#125;    //商品序号</span><br><span class="line">        public int ProductSold &#123; set; get; &#125;        //已售件数</span><br><span class="line">        public int ProductStock &#123; set; get; &#125;       //商品库存</span><br><span class="line">        public string ProductStatus &#123; set; get; &#125; // 商品状态</span><br><span class="line"></span><br><span class="line">        public List&lt;ProductImage&gt; productImages &#123; set; get; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>2、创建商品图片模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.ComponentModel.DataAnnotations;</span><br><span class="line">using Volo.Abp.Domain.Entities;</span><br><span class="line">using Volo.Abp.Domain.Values;</span><br><span class="line"></span><br><span class="line">namespace RuanMou.Projects.ProductServices.Models</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品图片</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class ProductImage : Entity&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        //[Key]</span><br><span class="line">        //public Guid Id &#123; set; get; &#125; // 主键</span><br><span class="line">        public Guid ProductId &#123; set; get; &#125; // 商品编号</span><br><span class="line">        public int ImageSort &#123; set; get; &#125; // 排序</span><br><span class="line">        public string ImageStatus &#123; set; get; &#125; // 状态（1：启用，2：禁用）</span><br><span class="line">        public string ImageUrl &#123; set; get; &#125; // 图片url</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、配置商品模型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.EntityFrameworkCore;</span><br><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Data;</span><br><span class="line"></span><br><span class="line">public class YDT_ProductServiceDbContext : AbpDbContext&lt;YDT_ProductServiceDbContext&gt;</span><br><span class="line">&#123;</span><br><span class="line">    public YDT_ProductServiceDbContext(DbContextOptions&lt;YDT_ProductServiceDbContext&gt; options)</span><br><span class="line">        : base(options)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 1、商品模型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public  DbSet&lt;Product&gt; products &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">    protected override void OnModelCreating(ModelBuilder builder)</span><br><span class="line">    &#123;</span><br><span class="line">        base.OnModelCreating(builder);</span><br><span class="line"></span><br><span class="line">        /* Include modules to your migration db context */</span><br><span class="line"></span><br><span class="line">        /* Configure your own entities here */</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>4、生成迁移文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add productservice</span><br></pre></td></tr></table></figure>
</li>
<li><p>​5、执行迁移文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure>
</li>
<li><p>6、应用商品微服务</p>
</li>
</ul>
<p>​&gt; 1、创建商品仓储接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Repositorys</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品仓储接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IProductRepository : IRepository&lt;Product,Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、创建商品仓储接口实现</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories.EntityFrameworkCore;</span><br><span class="line">using Volo.Abp.EntityFrameworkCore;</span><br><span class="line">using YDT_ProductService.Data;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Repositorys</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品仓储实现</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [Dependency(ServiceLifetime.Singleton)]</span><br><span class="line">    public class ProductRepository : EfCoreRepository&lt;YDT_ProductServiceDbContext, Product, Guid&gt;, IProductRepository</span><br><span class="line">    &#123;</span><br><span class="line">        public ProductRepository(IDbContextProvider&lt;YDT_ProductServiceDbContext&gt; dbContextProvider) : base(dbContextProvider)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​&gt; 3、创建商品Dto</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services.Dtos</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Dto</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class ProductDto :EntityDto&lt;Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        public string ProductCode &#123; set; get; &#125;    //商品编码</span><br><span class="line">        public string ProductUrl &#123; set; get; &#125;         // 商品主图</span><br><span class="line">        public string ProductTitle &#123; set; get; &#125;       //商品标题</span><br><span class="line">        public string ProductDescription &#123; set; get; &#125;     // 图文描述</span><br><span class="line">        public decimal ProductVirtualprice &#123; set; get; &#125; //商品虚拟价格</span><br><span class="line">        public decimal ProductPrice &#123; set; get; &#125;       //价格</span><br><span class="line">        public int ProductSort &#123; set; get; &#125;    //商品序号</span><br><span class="line">        public int ProductSold &#123; set; get; &#125;        //已售件数</span><br><span class="line">        public int ProductStock &#123; set; get; &#125;       //商品库存</span><br><span class="line">        public string ProductStatus &#123; set; get; &#125; // 商品状态</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4、创建商品Service接口</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service接口</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public interface IProductService : ICrudAppService&lt;ProductDto,Guid&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5、创建商品Service实现</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using Volo.Abp.Application.Services;</span><br><span class="line">using Volo.Abp.DependencyInjection;</span><br><span class="line">using Volo.Abp.Domain.Repositories;</span><br><span class="line">using YDT_ProductService.Repositorys;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Services</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 商品Service实现</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [Dependency(ServiceLifetime.Singleton)]</span><br><span class="line">    public class ProductService : CrudAppService&lt;Product, ProductDto, Guid&gt;, IProductService</span><br><span class="line">    &#123;</span><br><span class="line">        public ProductService(IProductRepository repository) : base(repository)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>6、创建商品控制器</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">using Microsoft.AspNetCore.Mvc;</span><br><span class="line">using Volo.Abp.Application.Dtos;</span><br><span class="line">using Volo.Abp.AspNetCore.Mvc;</span><br><span class="line">using YDT_ProductService.Services;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line">using YDTProductService.Migrations;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.Controllers;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 商品控制器</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;Product&quot;)]</span><br><span class="line">public class ProductController : AbpController</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 依赖注入IProductService</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public IProductService productService &#123; set; get; &#125; </span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 添加商品方法</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpPost]</span><br><span class="line">    public async Task&lt;ProductDto&gt; AddProduct(ProductDto productDto)</span><br><span class="line">    &#123;</span><br><span class="line">       // 1、实现添加商品</span><br><span class="line">       return await productService.CreateAsync(productDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取商品列表数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    [HttpPost]</span><br><span class="line">    public List&lt;ProductDto&gt; GetProducts()</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、实现添加商品</span><br><span class="line">        return  productService.GetListAsync(new PagedAndSortedResultRequestDto())</span><br><span class="line">            .Result.Items.ToList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>7、创建商品映射</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">using AutoMapper;</span><br><span class="line">using RuanMou.Projects.ProductServices.Models;</span><br><span class="line">using YDT_ProductService.Services.Dtos;</span><br><span class="line"></span><br><span class="line">namespace YDT_ProductService.ObjectMapping;</span><br><span class="line"></span><br><span class="line">public class YDT_ProductServiceAutoMapperProfile : Profile</span><br><span class="line">&#123;</span><br><span class="line">    public YDT_ProductServiceAutoMapperProfile()</span><br><span class="line">    &#123;</span><br><span class="line">        /* Create your AutoMapper object mappings here */</span><br><span class="line"></span><br><span class="line">        //1、商品ProductDto 映射为 Product</span><br><span class="line">        CreateMap&lt;ProductDto,Product&gt;();</span><br><span class="line">        //2、商品Product 映射为 ProductDto</span><br><span class="line">        CreateMap&lt;Product, ProductDto&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>7、访问商品微服务</p>
<pre><code>  VS2022启动订单微服务，然后在浏览器直接访问订单微服务
</code></pre>
</li>
</ul>
<h2 id="5-2、创建用户微服务"><a href="#5-2、创建用户微服务" class="headerlink" title="5.2、创建用户微服务"></a>5.2、创建用户微服务</h2><pre><code>进入YDT_MicroService解决方案，然后在YDT_MicroService解决方案中创建商品微服务
</code></pre>
<h3 id="1、创建用户微服务"><a href="#1、创建用户微服务" class="headerlink" title="1、创建用户微服务"></a>1、创建用户微服务</h3><pre><code>abp new YDT_UserService -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
<h3 id="2、修改用户微服务"><a href="#2、修改用户微服务" class="headerlink" title="2、修改用户微服务"></a>2、修改用户微服务</h3><pre><code>​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
<h3 id="3、迁移用户微服务"><a href="#3、迁移用户微服务" class="headerlink" title="3、迁移用户微服务"></a>3、迁移用户微服务</h3><h3 id="4、应用用户微服务"><a href="#4、应用用户微服务" class="headerlink" title="4、应用用户微服务"></a>4、应用用户微服务</h3><h3 id="5、访问用户微服务"><a href="#5、访问用户微服务" class="headerlink" title="5、访问用户微服务"></a>5、访问用户微服务</h3><h2 id="5-3、创建订单微服务"><a href="#5-3、创建订单微服务" class="headerlink" title="5.3、创建订单微服务"></a>5.3、创建订单微服务</h2><h3 id="1、创建订单微服务"><a href="#1、创建订单微服务" class="headerlink" title="1、创建订单微服务"></a>1、创建订单微服务</h3><pre><code>abp new YDT_OrderService -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
<h3 id="2、修改订单微服务"><a href="#2、修改订单微服务" class="headerlink" title="2、修改订单微服务"></a>2、修改订单微服务</h3><pre><code>​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
<h3 id="3、迁移订单微服务"><a href="#3、迁移订单微服务" class="headerlink" title="3、迁移订单微服务"></a>3、迁移订单微服务</h3><h3 id="4、应用订单微服务"><a href="#4、应用订单微服务" class="headerlink" title="4、应用订单微服务"></a>4、应用订单微服务</h3><h3 id="5、访问订单微服务"><a href="#5、访问订单微服务" class="headerlink" title="5、访问订单微服务"></a>5、访问订单微服务</h3><h2 id="5-4、创建支付微服务"><a href="#5-4、创建支付微服务" class="headerlink" title="5.4、创建支付微服务"></a>5.4、创建支付微服务</h2><h3 id="1、创建订单微服务-1"><a href="#1、创建订单微服务-1" class="headerlink" title="1、创建订单微服务"></a>1、创建订单微服务</h3><pre><code>abp new YDT_PaymentService -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
<h3 id="2、修改支付微服务"><a href="#2、修改支付微服务" class="headerlink" title="2、修改支付微服务"></a>2、修改支付微服务</h3><pre><code>​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
<h3 id="3、迁移支付微服务"><a href="#3、迁移支付微服务" class="headerlink" title="3、迁移支付微服务"></a>3、迁移支付微服务</h3><h3 id="4、应用支付微服务"><a href="#4、应用支付微服务" class="headerlink" title="4、应用支付微服务"></a>4、应用支付微服务</h3><h3 id="5、访问支付微服务"><a href="#5、访问支付微服务" class="headerlink" title="5、访问支付微服务"></a>5、访问支付微服务</h3><h3 id="6、创建微服务网关"><a href="#6、创建微服务网关" class="headerlink" title="6、创建微服务网关"></a>6、创建微服务网关</h3><ul>
<li><p>1、创建微服务网关</p>
<pre><code>  abp new YDT_Gateway -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
</li>
<li><p>2、修改微服务网关</p>
<pre><code>  ​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
</li>
<li><p>3、应用微服务网关</p>
</li>
<li><p>4、访问微服务网关</p>
</li>
</ul>
<h3 id="7、创建电商网站"><a href="#7、创建电商网站" class="headerlink" title="7、创建电商网站"></a>7、创建电商网站</h3><ul>
<li><p>1、创建电商网站</p>
<pre><code>  abp new YDT_WebSites -t app-nolayers --dbms mysql -u none -csf -v 7.3.0
</code></pre>
</li>
<li><p>2、修改电商网站</p>
<pre><code>  ​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
</li>
<li><p>3、应用电商网站</p>
</li>
<li><p>4、访问电商网站</p>
</li>
</ul>
<h3 id="8、创建基础设施"><a href="#8、创建基础设施" class="headerlink" title="8、创建基础设施"></a>8、创建基础设施</h3><ul>
<li><p>1、创建基础设施</p>
<p>  abp new YDT_Framework -t console -v 7.3.0</p>
</li>
<li><p>2、修改基础设施</p>
<pre><code>  ​ 去掉ABP自带的应用模块，留下ABP框架部分
</code></pre>
</li>
<li><p>3、应用基础设施</p>
</li>
<li><p>4、访基础设施</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/01/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/1%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/01/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/1%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">1、千万级秒杀项目实战简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-01 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-01T10:48:57+08:00">2023-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-19 16:11:24" itemprop="dateModified" datetime="2024-02-19T16:11:24+08:00">2024-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/01/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/1%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%AE%80%E4%BB%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/01/%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/1%E3%80%81%E5%8D%83%E4%B8%87%E7%BA%A7%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E7%AE%80%E4%BB%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="千万级秒杀项目"><a href="#千万级秒杀项目" class="headerlink" title="千万级秒杀项目"></a>千万级秒杀项目</h1><p>目标：从0到1构建一个高并发的秒杀系统</p>
<p>三个阶段</p>
<p>从0到1构建一个电商系统</p>
<p>从0到1构建秒杀系统</p>
<p>从0到1构建高并发秒杀系统</p>
<p>为了完成这个目标，我们需要知道几个前提</p>
<p>1、什么是电商</p>
<p>2、什么是秒杀</p>
<p>3、什么是高并发</p>
<p>4、如何设计高并发秒杀系统</p>
<h1 id="什么是电商"><a href="#什么是电商" class="headerlink" title="什么是电商"></a>什么是电商</h1><p>商家通过互联网(软件)的方式来销售商品。就是电商。</p>
<p>例如，我们所看到的，什么淘宝，京东之类。良品铺子，都可以在网上进行购买他们的商品，这些就是电商</p>
<h2 id="电商类型"><a href="#电商类型" class="headerlink" title="电商类型"></a>电商类型</h2><p>个人电商：</p>
<p>​ 软件只买一家门店的商品就是个人电商，</p>
<p>​ 例如：良品铺子通过软件买的商品，各位同学去开一家门店，然后通过软件来卖自家的商品，就是电商</p>
<p>平台电商</p>
<p>​ 软件卖多家门店的商品就是平台电商，例如：淘宝，京东就属于这一类</p>
<h2 id="如何开发电商"><a href="#如何开发电商" class="headerlink" title="如何开发电商"></a>如何开发电商</h2><h3 id="为什么会出现电商"><a href="#为什么会出现电商" class="headerlink" title="为什么会出现电商"></a>为什么会出现电商</h3><p>首先，我们要弄明白一点，没有电商之前，我们是通过门店来销售商品，还有的是通过会销等其他方式，我们只讨论门店销售</p>
<p>这一块。</p>
<p>这个时候，随着互联网的出现，越来越多的人发现门店销售有限，只能够销售一方，这个时候就有人想，如果我们想将商品销售到全中国，于是有人准备去开很多分店去解决，但是发现，成本太高。这个时候，有人就想，我们想销售到全中国的同时，想大量的降低成本。所以大家发现互联网发送一个消息全中国的人都可以收到，于是，马云说，我们来尝试一下吧。成功我就发了，不成功 ，我就做杭州教英语，继续老师。没有想到，成功了，所以了就出现了电商。</p>
<p>我为什么要说这段故事呢，很简单，大家有没有发现，电商的前身就是门店，他们两个是不同场合不同的名称。就好像黑白无常一样，知道了黑，就知道了白。</p>
<p>所以，如果我们想开发一个电商项目，就必须知道门店是如何经营的，也就是说，我们必须知道门店他们是如何卖商品的。有哪些角色组成。</p>
<p>大家好好想一下，门店内卖商品的流程，我就比如去良品铺子进行</p>
<p>消费者，商品，付钱，发票单(个人电商)</p>
<p>消费者—–&gt;选择商品——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<p>我们就可以得到最简单的商品购买流程。（个人大型电商）</p>
<p>如果出现超市之类的，加一个购物车，先放到购物车，然后一起付钱</p>
<p>消费者—–&gt;选择商品—–&gt;购物车——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<p>如果是去商场之类的，就加一个商家（平台电商）</p>
<p>消费者—–&gt;商家——&gt;选择商品—–&gt;购物车——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<h3 id="模块设计"><a href="#模块设计" class="headerlink" title="模块设计"></a>模块设计</h3><p>我们以开发一个最简单的电商项目为例</p>
<p>消费者—–&gt;选择商品——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<p>我们可以得出这4个模块</p>
<p>用户模块</p>
<p>商品模块</p>
<p>支付模块</p>
<p>订单模块</p>
<p>不管多复杂的电商，所有的都是在这个基础上扩展出来的新的模块，例如：购物车，商家，发货，评价，退款，秒杀等等</p>
<h2 id="什么是秒杀"><a href="#什么是秒杀" class="headerlink" title="什么是秒杀"></a>什么是秒杀</h2><p>秒杀就是在很短时间内，卖出所有的商品。</p>
<p>就好比，我们在淘宝网看到的商品，京东上看到的秒杀，我们扩展一下，还有很多类似的场景</p>
<p>春节，我们在12306抢票，我们在支付宝抢红包，在微服务摇一摇等等都是秒杀的场景。</p>
<p>在指定时间内把商品快速卖给顾客</p>
<h3 id="秒杀类型"><a href="#秒杀类型" class="headerlink" title="秒杀类型"></a>秒杀类型</h3><p>1秒秒杀类型</p>
<p>​ 1秒类秒杀有限商品</p>
<p>分钟秒杀类型</p>
<p>​ 一分钟之类秒杀有限商品</p>
<p>小时秒杀类型</p>
<p>​ 1小时之类秒杀所有商品</p>
<p>1天内秒杀类型</p>
<p>​ 1天之类秒杀所有商品</p>
<h2 id="如何实现秒杀系统"><a href="#如何实现秒杀系统" class="headerlink" title="如何实现秒杀系统"></a>如何实现秒杀系统</h2><h3 id="为什么会出现秒杀"><a href="#为什么会出现秒杀" class="headerlink" title="为什么会出现秒杀"></a>为什么会出现秒杀</h3><p>我们刚才看到，秒杀就是在有限的时间秒杀商品，说明秒杀针对的对象还是商品</p>
<p>说明什么，说明秒杀是在商品的基础上扩展出来的。只是加了有一个时间限制。所以我们可以得到秒杀商品是属于商品的一个类型，属于什么类型呢，属于商品营销类型，秒杀本质上就是一种营销活动，所以我们可以得出秒杀就是商品的营销类型。</p>
<p>因此，如果我们要设计一个秒杀系统，我们必须知道电商的逻辑</p>
<p>消费者—–&gt;选择商品——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<p>消费者—–&gt;秒杀商品(时间限制)——&gt;付钱——–&gt;发票单(什么时候买的什么商品)</p>
<h3 id="模块设计-1"><a href="#模块设计-1" class="headerlink" title="模块设计"></a>模块设计</h3><p>所有秒杀系统设计还是和原有逻辑没有变化，只是把普通商品替换了。</p>
<p>其实我们只需要设计一个模块即可，我们可以把时间设置到秒杀模块里面，但是时间有很多类型，很多商品都需要设置时间</p>
<p>秒杀模块</p>
<p>时间模块</p>
<h3 id="秒杀系统过渡到高并发"><a href="#秒杀系统过渡到高并发" class="headerlink" title="秒杀系统过渡到高并发"></a>秒杀系统过渡到高并发</h3><p>如果我们想将一个秒杀系统设计成为一个高并发的秒杀系统，光有这些设计是不够的，我们还需要知道什么是高并发</p>
<p>前面我们讲过了相应的高并发知识点，但是我们在这里还是要回顾一下高并发的知识点。</p>
<h2 id="什么是高并发"><a href="#什么是高并发" class="headerlink" title="什么是高并发"></a>什么是高并发</h2><p>高并发就是在1秒内用户请求非常大，服务器能够处理在1秒之内能够这些请求，不会导致服务器宕机。就是高并发。</p>
<p>高并发指的是1秒内用户用户请求数，高并发能力就是指服务器处理能力。</p>
<h3 id="多大才算高并发"><a href="#多大才算高并发" class="headerlink" title="多大才算高并发"></a>多大才算高并发</h3><p>那么什么用户达到多少请求才算是高并发呢？</p>
<p>答案：这个问题的答案不是指系统处理的一个数字。</p>
<h3 id="为什么会有高并发"><a href="#为什么会有高并发" class="headerlink" title="为什么会有高并发"></a>为什么会有高并发</h3><p>一般我们开发一个项目，都会把所有的模块全部一次性放到一个项目中进行开发，然后进行部署，最后进行优化。</p>
<p>如果我们的系统目前并发量为300，也就是每秒能够处理300个请求。</p>
<p>随着用户请求数，在1秒内出来的请求，发出600并发，这个时候，系统变得非常慢。接下来，我们就开始优化，如何保证系统能够处理600个并发量，</p>
<p>如果我们优化后，单机可以达到600并发量的出来，</p>
<p>但是，用户数是不稳定的，如果用户在1秒内请求持续加大，达到了1000千，</p>
<p>我们接下来继续优化系统，发现系统的1秒最高并发量为600，大了就响应变慢，甚至宕机了。</p>
<p>这个时候，我们又开始优化，如何 保证系统能够处理1000并发量。</p>
<p>随着用户数，持续增大，到达45</p>
<p>42·9 2000,10000,10W,100W持续增加，那我们系统如何能处理这么大的请求量呢 ？</p>
<p>答案：继续优化。</p>
<p>现在我们发现系统处理的请求数是一个持续的问题，不是一劳永逸的问题。</p>
<p>来看一个场景：</p>
<p>固态硬盘SSD（Solid State Disk）说：我读取和写入高达 1000MB&#x2F;秒</p>
<p>mysql说：我单机TPS10000+</p>
<p>nginx说：我单机QPS10W+</p>
<p>静儿说：给我一台56核200G高配物理机，我可以创建一个单机QPS1000W</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果硬是要说高并发有一个标准，就是超过了单机处理的最大并发量，就算是高并发</p>
<p>高并发的本质不是「多大算高并发」的一个数字，而是从架构上、设计上、编码上怎么来保证或者解决由并发引起的问题。</p>
<p>当别人问你：“做过高并发吗？”回答者完全可以描述自己系统的各项指标，然后开始叙述自己对系统中对预防、解决并发问题作出的思考和行动。</p>
<h2 id="高并发量级"><a href="#高并发量级" class="headerlink" title="高并发量级"></a>高并发量级</h2><p>高并发量级一般是指系统能够在一天处理的请求数</p>
<p>千万级并发</p>
<p>亿级并发</p>
<p>10亿级并发</p>
<h3 id="服务器并发处理能力"><a href="#服务器并发处理能力" class="headerlink" title="服务器并发处理能力"></a>服务器并发处理能力</h3><p>1秒内能够响应的请求数。这个数有多大，才是服务器并发能力</p>
<h2 id="如何实现高并发"><a href="#如何实现高并发" class="headerlink" title="如何实现高并发"></a>如何实现高并发</h2><h3 id="拆分原则"><a href="#拆分原则" class="headerlink" title="拆分原则"></a>拆分原则</h3><p>​ 系统角度：按照系统功能&#x2F;业务功能拆分，比如商品系统，购物车系统，结算系统，订单系统等</p>
<p>​ 功能角度：对一个系统功能进行再次拆分，比如，优惠券系统可以拆分为后台劵创建系统，领劵系统，用劵系统</p>
<p>​ 读写角度：根据读写比例特征进行拆分，比如，商品系统，交易的各个系统都会读取数据，读的流量大于写，因此可以拆分成商品写服务，商品读服务，读服务 可以考虑使用缓存提升性能，写的量太大，需要考虑分库分表，有些聚合读写的场景，如商品详情页，可考虑数据异构拆分系统，将分散在多处的数据聚合在一起存储，以提升系统的性能和可靠性。</p>
<p>​ aop角度：根据访问特征，按照AOP进行拆分，比如，商品详情页可以拆分为CDN,页面渲染系统，CDN就是一个AOP系统，</p>
<p>​ 模块角度：比如，按照基础或者代码维护特征进行拆分，如基础模块分库分表，数据库连接池等，代码结构一般按照三层架构（Web Service DAO）进行划分</p>
<h3 id="无状态原则"><a href="#无状态原则" class="headerlink" title="无状态原则"></a>无状态原则</h3><p>​ 如果设计的系统是无状态的，那么应用就非常容易水平扩展，实际生产环境可能是这样的，应用无状态，配置文件有状态，比如，不同的机房需要读取不同的数据源，此时，就需要通过配置文件或配置中心指定。</p>
<h3 id="服务化原则"><a href="#服务化原则" class="headerlink" title="服务化原则"></a>服务化原则</h3><p>​ 首先，判断是不是只需要简单的单点远程服务调用，单机不行集群是不是就可以解决，在客户端注册多台机器并使用Nginx进行负载均衡是不是就可以解决？</p>
<p>​ 总结为：进程内服务——&gt;单机远程服务——&gt;集群手动注册服务——–&gt;自动注册和发现服务———&gt;服务的分组&#x2F;隔离&#x2F;路由&#x2F;——&gt;服务治理</p>
<h3 id="消息队列原则"><a href="#消息队列原则" class="headerlink" title="消息队列原则"></a>消息队列原则</h3><p>​ 消息队列用来解耦一些不需要同步调用的服务或者订阅一些自己系统关关系的变化。</p>
<p>​ 使用消息队列可以实现服务解耦(一对一消费，一对多消费)，异步处理，流量削峰&#x2F;缓冲等</p>
<p>​ 比如：电商系统中的交易数据，有非常多的系统关系并订阅该数据。</p>
<p>​ 比如：订单生产系统</p>
<h3 id="缓存原则"><a href="#缓存原则" class="headerlink" title="缓存原则"></a>缓存原则</h3><p>​ 本地缓存：内存缓存，属于进程的缓存。</p>
<p>​ 本地分布式缓存：内存缓存，多进程共享，但是通过内网进行访问的缓存。</p>
<p>​ 分布式缓存：外部内存缓存，多进程共享，但是通过外网进行访问的缓存。</p>
<h3 id="异步并发化原则"><a href="#异步并发化原则" class="headerlink" title="异步并发化原则"></a>异步并发化原则</h3><p>​ 假设一个读服务需要如下数据，数据A，数据B，数据C,数据D，数据E 时间分别为10ms,15ms,10ms,20ms,5ms,</p>
<p>​ 如果串行读取，需要花费60ms,</p>
<p>​ 如果数据C依赖A,B,数据D谁 也不依赖，数据E依赖数据C，那么就可以直接并发读取A,B,D ,AB被C读取，然后再读取E，总读取时间为30ms,性能优化了一倍。</p>
<h2 id="如何设计秒杀高并发系统"><a href="#如何设计秒杀高并发系统" class="headerlink" title="如何设计秒杀高并发系统"></a>如何设计秒杀高并发系统</h2><p>前提是我们必须要知道目前我们的系统是2000万秒杀20万手机。真正的并发量是多少。</p>
<h3 id="计算2000万的并发量"><a href="#计算2000万的并发量" class="headerlink" title="计算2000万的并发量"></a>计算2000万的并发量</h3><p>每台服务器每秒处理请求的数量&#x3D;((80%<em>总PV量)&#x2F;(24小时</em>60分<em>60秒</em>40%)) &#x2F; 服务器数量 。<br>其中关键的参数是80%、40%。表示一天中有80%的请求发生在一天的40%的时间内。24小时的40%是9.6小时，有80%的请求发生一天的9.6个小时当中（很适合互联网的应用，白天请求多，晚上请求少）。</p>
<h3 id="一天时间"><a href="#一天时间" class="headerlink" title="一天时间"></a>一天时间</h3><p>如果我们要求2000万人在1天内抢完20万个手机。</p>
<p>平均值：20000000 &#x2F; 86400 &#x3D; 232&#x2F;s</p>
<p>峰值：20000000 * 80% &#x2F; 86400 * 40 &#x3D; 232&#x2F;s</p>
<p>​ 16000000&#x2F;34560 &#x3D; 463&#x2F;s</p>
<h3 id="一个小时"><a href="#一个小时" class="headerlink" title="一个小时"></a>一个小时</h3><p>计算每秒服务器每秒需要处理的数量</p>
<p>平均值：20000000 &#x2F; 1<em>60</em>60 &#x3D;5556&#x2F;s (QPS)</p>
<p>峰值：16000000&#x2F;1440 &#x3D; 13889&#x2F;s(QPS)</p>
<p>峰值：16000000&#x2F;720 &#x3D; 27778&#x2F;s(QPS)</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>好像看起来是一条水平线，可是用户不听我们的呀，我们必须得算出一个峰值呀，</p>
<p>这样才能够算是真实的，目前有一个</p>
<p>假如目前aspnetcore项目每秒能够处理500个并发</p>
<p>大家可以估算一下，需要多少台机器</p>
<p>答案：56台服务器。</p>
<p>可是这只是我们的一个估算，我们该如何知道真实的呢？</p>
<p>两个前提，</p>
<p>1、电商系统</p>
<p>2、秒杀系统</p>
<p>那么，我们如何设计这些系统呢？</p>
<h2 id="电商系统设计"><a href="#电商系统设计" class="headerlink" title="电商系统设计"></a>电商系统设计</h2><p>用户模块</p>
<p>商品模块</p>
<p>支付模块</p>
<p>订单模块</p>
<h2 id="秒杀系统设计"><a href="#秒杀系统设计" class="headerlink" title="秒杀系统设计"></a>秒杀系统设计</h2><p>秒杀模块</p>
<p>时间模块</p>
<h2 id="高并发秒杀系统相关技术"><a href="#高并发秒杀系统相关技术" class="headerlink" title="高并发秒杀系统相关技术"></a>高并发秒杀系统相关技术</h2><p>相关技术：微服务,webapi aspnetcore，restful ,缓存，消息队列，限流，nginx,docker k8s,服务治理,IdentityServer4 mysql linux 自己研发小框架。</p>
<p>相关工具：jmeter</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/08/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/1%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/08/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/1%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">1、微服务-电商项目实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-01 10:48:57" itemprop="dateCreated datePublished" datetime="2023-08-01T10:48:57+08:00">2023-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-30 23:33:33" itemprop="dateModified" datetime="2024-01-30T23:33:33+08:00">2024-01-30</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/08/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/1%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/08/01/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/1%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1、微服务-电商项目实战"><a href="#1、微服务-电商项目实战" class="headerlink" title="1、微服务-电商项目实战"></a>1、微服务-电商项目实战</h1><ul>
<li><p>什么服务</p>
<ul>
<li>为产品提供部件的产品（系统）<ul>
<li>1、页面</li>
<li>2、系统</li>
</ul>
</li>
</ul>
</li>
<li><p>什么是微服务</p>
<ul>
<li>为产品（系统）提供一个部件的服务</li>
<li>只做一件事的服务<br>  <img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-1.png" alt="Alt text"></li>
</ul>
</li>
<li><p>微服务抽象示意图<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-2.png" alt="Alt text"></p>
</li>
<li><p>为什么使用微服务</p>
<ul>
<li>微服务好处：<br>  1、提升系统稳定性。<br>  2、易于排错。<br>  3、方便维护。<br>  4、易于复用。</li>
<li>微服务遵守：<br>  1、单一职责性。缺陷：<br>  1、微服务数量过多。系统复杂性上升。</li>
</ul>
</li>
</ul>
<blockquote>
<p>微服务架构：解决微服务数量过多，系统复杂性上升的问题</p>
</blockquote>
<h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><h2 id="什么是架构"><a href="#什么是架构" class="headerlink" title="什么是架构"></a>什么是架构</h2><ul>
<li>产品内部先后顺序结构<br>  1、页面内部先后顺序结构<br>  2、系统内部先后顺序结构<br>  3、模块内部先后顺序结构<br>  <img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-3.png" alt="Alt text"></li>
</ul>
<h2 id="什么是微服务架构"><a href="#什么是微服务架构" class="headerlink" title="什么是微服务架构"></a>什么是微服务架构</h2><ul>
<li><p>微服务调用先后顺序结构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-4.png" alt="Alt text"></p>
</li>
<li><p>架构：<br>  1、产品内部接构<br>  2、功能内部结构<br>  <img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-5.png" alt="Alt text"></p>
</li>
<li><p>微服务架构平面图<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-6.png" alt="Alt text"></p>
</li>
<li><p>微服务架构好处：<br>1、解决并发量问题<br>2、解决数据量问题<br>3、解决业务量问题<br>4、解决团队量问题</p>
</li>
</ul>
<h1 id="项目为什么要使用微服务架构"><a href="#项目为什么要使用微服务架构" class="headerlink" title="项目为什么要使用微服务架构"></a>项目为什么要使用微服务架构</h1><ul>
<li><p>单体架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-10.png" alt="Alt text"></p>
</li>
<li><p>单数据库多应用架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-11.png" alt="Alt text"></p>
</li>
<li><p>主从数据库读写分离架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-12.png" alt="Alt text"></p>
</li>
<li><p>主从数据库读写分离+缓存架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-13.png" alt="Alt text"></p>
</li>
<li><p>面向服务(SOA)架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-14.png" alt="Alt text"></p>
</li>
<li><p>微服务架构<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-15.png" alt="Alt text"></p>
</li>
<li><p>微服务架构-聚合服务层<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-16.png" alt="Alt text"></p>
</li>
</ul>
<h1 id="微服务架构落地"><a href="#微服务架构落地" class="headerlink" title="微服务架构落地"></a>微服务架构落地</h1><h2 id="微服务拆分"><a href="#微服务拆分" class="headerlink" title="微服务拆分"></a>微服务拆分</h2><ul>
<li><p>系统拆分图<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-18.png" alt="Alt text"></p>
</li>
<li><p>业务层面拆分<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-19.png" alt="Alt text"></p>
</li>
<li><p>业务模块层面拆分<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-20.png" alt="Alt text"></p>
</li>
<li><p>功能层面拆分<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-21.png" alt="Alt text"></p>
</li>
<li><p>读写层面拆分<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-22.png" alt="Alt text"></p>
</li>
</ul>
<h3 id="微服务拆分原则"><a href="#微服务拆分原则" class="headerlink" title="微服务拆分原则"></a>微服务拆分原则</h3><pre><code>拆分前提
1、业务量。
2、数据量。
3、并发量。
原则：
1、先大后小。
2、团队成员大小
总结：
1、公司人越多，服务拆分就越细。
2、公司人越少，服务拆分就越粗。
</code></pre>
<h1 id="微服务架构设计模式"><a href="#微服务架构设计模式" class="headerlink" title="微服务架构设计模式"></a>微服务架构设计模式</h1><ul>
<li>链式设计模式<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-23.png" alt="Alt text"></li>
<li>聚合器设计模式<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-24.png" alt="Alt text"></li>
<li>聚合器设计具体实例<br><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-25.png" alt="Alt text"></li>
</ul>
<h1 id="电商微服务架构落地"><a href="#电商微服务架构落地" class="headerlink" title="电商微服务架构落地"></a>电商微服务架构落地</h1><h2 id="单体电商项目"><a href="#单体电商项目" class="headerlink" title="单体电商项目"></a>单体电商项目</h2><p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-26.png" alt="Alt text"></p>
<h2 id="电商微服务项目"><a href="#电商微服务项目" class="headerlink" title="电商微服务项目"></a>电商微服务项目</h2><p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-27.png" alt="Alt text"></p>
<h2 id="电商微服务项目架构"><a href="#电商微服务项目架构" class="headerlink" title="电商微服务项目架构"></a>电商微服务项目架构</h2><p><img src="/BlogPro/images%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98/image-28.png" alt="Alt text"></p>
<h1 id="电商微服务项目落地"><a href="#电商微服务项目落地" class="headerlink" title="电商微服务项目落地"></a>电商微服务项目落地</h1><pre><code>开发环境
1、VS20222、.NET73、MySQL 5.7
框架
1、ABP vNext
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://smdegz.github.io/BlogPro/2023/06/06/%E5%85%A8%E6%A0%88%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81EFCore%E6%A1%86%E6%9E%B6%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/BlogPro/images/Wx.jpg">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="这里是何锦祥的博客，记录生活点滴，分享思考与感悟。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何锦祥 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/BlogPro/2023/06/06/%E5%85%A8%E6%A0%88%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81EFCore%E6%A1%86%E6%9E%B6%E8%B0%83%E4%BC%98/" class="post-title-link" itemprop="url">6、EFCore框架调优</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-06 10:48:57" itemprop="dateCreated datePublished" datetime="2023-06-06T10:48:57+08:00">2023-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-29 23:48:18" itemprop="dateModified" datetime="2024-01-29T23:48:18+08:00">2024-01-29</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/BlogPro/2023/06/06/%E5%85%A8%E6%A0%88%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81EFCore%E6%A1%86%E6%9E%B6%E8%B0%83%E4%BC%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/BlogPro/2023/06/06/%E5%85%A8%E6%A0%88%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/6%E3%80%81EFCore%E6%A1%86%E6%9E%B6%E8%B0%83%E4%BC%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="EFCore-自带缓存机制"><a href="#EFCore-自带缓存机制" class="headerlink" title="EFCore 自带缓存机制"></a>EFCore 自带缓存机制</h1><blockquote>
<p>EF Core 内部有实现缓存机制，每次查询SQL命令时，自动对结果数据进行缓存<br> Entity Framework Core (EF Core) 提供了一个内置的缓存机制，这个缓存机制主要用于在上下文中跟踪和管理实体对象的状态，以提高查询性能和减少数据库访问次数。以下是 EF Core 自带的缓存机制的一些基本原理：</p>
</blockquote>
<ul>
<li><ol>
<li><p>Identity Map（标识映射）<br>   唯一性： EF Core 的缓存是一个 Identity Map，它确保在上下文中的每个实体对象仅有一个实例，即同一个实体在内存中的表示是唯一的。</p>
<p>   跟踪变更： 通过 Identity Map，EF Core 能够追踪实体对象的变更，包括添加、修改和删除。这些变更在 SaveChanges 被调用时会被同步到数据库。</p>
</li>
</ol>
</li>
<li><ol start="2">
<li><p>Change Tracking（变更跟踪）<br>   对象状态： EF Core 使用 Change Tracking 来记录实体对象的状态，包括 Added（新增）、Modified（修改）、Deleted（删除）和 Unchanged（未修改）等状态。</p>
<p>   自动检测变更： 当你在代码中对实体属性进行更改时，EF Core 会自动检测并标记相应的实体状态为 Modified。</p>
</li>
</ol>
</li>
<li><ol start="3">
<li><p>Local Cache（本地缓存）<br>   一级缓存： EF Core 在上下文中维护一个一级缓存（Local Cache），用于存储当前上下文中加载的实体。这个缓存可以减少对数据库的重复查询。</p>
<p>   生命周期： 缓存的生命周期通常是在上下文的生命周期内，当上下文被销毁时，缓存中的实体对象也会被释放。</p>
</li>
</ol>
</li>
<li><ol start="4">
<li><p>Query Cache（查询缓存）<br>   查询缓存： EF Core 还提供了一个查询缓存，用于存储已执行查询的结果，以便在相同的查询被再次执行时，能够直接从缓存中获取结果，而无需重新执行查询。</p>
<p>   缓存策略： 缓存的生命周期通常是相对短暂的，而且可以通过配置来调整缓存策略，以满足具体应用的需求。</p>
</li>
</ol>
</li>
<li><ol start="5">
<li>AsNoTracking（关闭跟踪）<br>   禁用跟踪： 在某些场景下，你可能希望禁用 EF Core 的跟踪机制，以减轻上下文的内存压力，可以使用 AsNoTracking 方法来告诉 EF Core 不要追踪查询结果。<br>   csharp<br>   Copy code<br>   var entities &#x3D; dbContext.Entities.AsNoTracking().ToList();<br>   需要注意的是，EF Core 的缓存机制是针对上下文内部的数据状态管理，它并不是一个通用的查询结果缓存，如果需要更高级的缓存策略，你可能需要考虑使用其他缓存机制，如分布式缓存。</li>
</ol>
</li>
<li><p>不要使用Contains()方法进行模糊查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    //var result = SeckillContext.Seckills.ToList();</span><br><span class="line">    // 1、模糊查询商品列表。 1、全文索引</span><br><span class="line">    #region 1、根据条件模糊查询商品.通过商品名称</span><br><span class="line">    &#123;</span><br><span class="line">        // 匹配结束(会走索引) like</span><br><span class="line">        var Seckill2 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.EndsWith(&quot;P&quot;)).ToList();</span><br><span class="line"></span><br><span class="line">        // 匹配开始(会走索引) like</span><br><span class="line">        var Seckill1 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;)).ToList();</span><br><span class="line"></span><br><span class="line">        // 匹配开始(不会走索引) like</span><br><span class="line">        var Seckill3 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.Contains(&quot;P&quot;)).ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>只返回必要的字段，字段越多，越浪费资源，所需时间也越多</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    // 2、客户端要求查询商品。只返回商品价格</span><br><span class="line">    #region 2、指定列查询。</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、所有列查询</span><br><span class="line">        /*foreach (var seckill in SeckillContext.Seckills)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Seckill: &quot; + seckill.SeckillPrice);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 2、指定列查询</span><br><span class="line">        foreach (var SeckillPrice in SeckillContext.Seckills.Select(b =&gt;new &#123; b.SeckillPrice, b.SeckillName &#125;))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;Seckill: &quot; + SeckillPrice);</span><br><span class="line">        &#125;*/</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>限制结果集，减少请求数量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    // 3、批量查询商品数据。</span><br><span class="line">    #region 3、限制结果集  Take limit</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、查询结果集</span><br><span class="line">        var seckills1 = SeckillContext.Seckills</span><br><span class="line">        .Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;))</span><br><span class="line">        .ToList();</span><br><span class="line"></span><br><span class="line">        // 2、限制结果集</span><br><span class="line">        var seckills2 = SeckillContext.Seckills</span><br><span class="line">        .Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;))</span><br><span class="line">        .Take(1) // 限制结果集数量。</span><br><span class="line">        .Skip(0) // 数据的偏移量</span><br><span class="line">        .ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询数据时，尽量使用缓存或者缓冲，提高查询性能</p>
</li>
<li><p>缓存，可以多次存储，缓冲，只能存储一次，使用后会清空</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    #region 4、缓冲和流式处理</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、流式处理(遍历查询每次查询数据库）</span><br><span class="line">        var seckills = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;));</span><br><span class="line">        foreach (var seckill in seckills)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(seckill.SeckillName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 2、缓冲处理(分页查询。非常.ToList() ToArray())</span><br><span class="line">        var seckills1 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;)).ToList();</span><br><span class="line">        var seckills2 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;)).ToArray();</span><br><span class="line"></span><br><span class="line">        // 3、流式处理(内存资源)</span><br><span class="line">        var seckills3 = SeckillContext.Seckills</span><br><span class="line">        .Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;))</span><br><span class="line">        .AsEnumerable();</span><br><span class="line">     &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>尽量使用非跟踪查询，节约操作及时间（跟踪会记录操作，非跟踪不会记录操作）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">     #region 5、尽量使用非跟踪查询</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、跟踪查询</span><br><span class="line">        var seckills1 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;)).AsTracking().ToList();</span><br><span class="line">        seckills1[0].SeckillName = &quot;123123&quot;;</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">        // 2、非跟踪查询</span><br><span class="line">        var seckills2 = SeckillContext.Seckills.Where(p =&gt; p.SeckillName.StartsWith(&quot;P&quot;)).AsNoTracking().ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>多使用异步查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">     #region 6、使用异步</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、同步处理</span><br><span class="line">        var sec = SeckillContext.Seckills.Where(b =&gt; b.SeckillName.StartsWith(&quot;P&quot;)).ToList();</span><br><span class="line"></span><br><span class="line">        // 2、异步处理。时间来获取先后顺序</span><br><span class="line">        var blogs = await SeckillContext.Seckills.Where(b =&gt; b.SeckillName.StartsWith(&quot;P&quot;)).ToListAsync();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联查询的时候，使用懒加载，需要的时候使用，不需要的时候为空</p>
</li>
<li><p>在 Startup 类的 ConfigService 方法里面添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 3、开启懒加载(导航属性需要就用，不需要就不用)</span><br><span class="line">options.UseLazyLoadingProxies();</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    // 4、关联查询。查询商品--商品浏览记录。懒加载----&gt; </span><br><span class="line">    #region 7、关联查询尽量预加载  查询商品--商品浏览记录</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、关联延迟加载。会出现 1+N问题。1+N 一次商品。N次商品记录查询。</span><br><span class="line">        var seckills = SeckillContext.Seckills.ToList();</span><br><span class="line">        foreach (var seckill in seckills)</span><br><span class="line">        &#123;</span><br><span class="line">            foreach (var seckillRecord in seckill.seckillRecords)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine($&quot;seckillRecord &#123;seckillRecord.RecordTotalprice&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 2、关联预先加载。一次性所有加载。</span><br><span class="line">        var seckills1 = SeckillContext.Seckills.Include(seckill =&gt; seckill.seckillRecords).ToList();</span><br><span class="line">        foreach (var seckill in seckills1)</span><br><span class="line">        &#123;</span><br><span class="line">            foreach (var seckillRecord in seckill.seckillRecords)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine($&quot;seckillRecord &#123;seckillRecord.RecordTotalprice&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return seckills;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联查询的时候，使用 AsSplitQuery 分开查询，避免笛卡尔积的问题（笛卡尔积问题：关联查询时，副表没有数据，会把所有副表字段都查询出来，影响性能）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    #region 8、关联查询(避免笛卡尔积) // 1、查询商品----&gt;商品记录返回</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、关联查询(预先加载)</span><br><span class="line">        var seckills1 = SeckillContext.Seckills</span><br><span class="line">        .Include(seckill =&gt; seckill.seckillRecords)</span><br><span class="line">        .ToList();</span><br><span class="line"></span><br><span class="line">        // 2、关联拆分查询(预先加载笛卡尔积的问题)</span><br><span class="line">        var seckills2 = SeckillContext.Seckills</span><br><span class="line">        .Include(seckills =&gt; seckills.seckillRecords)</span><br><span class="line">        .AsSplitQuery() // efcore 5.0 .AsSingleQuery()//分开查询。</span><br><span class="line">        .ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>尽量使用原始SQL语句查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    #region 9、使用原始sql</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、sql查询</span><br><span class="line">        var seckills = SeckillContext.Seckills.FromSqlRaw(&quot;select * from seckills&quot;).ToList();</span><br><span class="line"></span><br><span class="line">        // 2、原始sql执行存储过程</span><br><span class="line">        var blogs = SeckillContext.Seckills</span><br><span class="line">        .FromSqlRaw(&quot;EXECUTE dbo.GetMostPopularBlogs&quot;)</span><br><span class="line">        .ToList();</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用批处理，不要一个个执行语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">     #region 10、批处理(默认执行42个。默认只会执行42个)</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、多个sql语句操作（默认用的是：跟踪）</span><br><span class="line">        var seckill1 = SeckillContext.Seckills.Single(b =&gt; b.SeckillName == &quot;P6&quot;); // 单个数据查询</span><br><span class="line">        seckill1.SeckillName = &quot;iPhone&quot;;</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">        SeckillContext.Seckills.Add(new Seckill &#123; SeckillName = &quot;phone3&quot; &#125;);</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">        SeckillContext.Seckills.Add(new Seckill &#123; SeckillName = &quot;phone4&quot; &#125;);</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">        // 2、批处理(跟踪更新)</span><br><span class="line">        var seckill2 = SeckillContext.Seckills.Single(b =&gt; b.SeckillName == &quot;iPhone&quot;);</span><br><span class="line">        seckill2.SeckillName = &quot;iPhone 13&quot;;</span><br><span class="line">        SeckillContext.Add(new Seckill &#123; SeckillName = &quot;phone2&quot; &#125;);</span><br><span class="line">        SeckillContext.Add(new Seckill &#123; SeckillName = &quot;phone3&quot; &#125;);</span><br><span class="line">        // 41条批量语句</span><br><span class="line">        // 100000万条。直接sql</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在Startup类的ConfigService方法配置批处理数量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 1、添加数据库上下文到IOC容器</span><br><span class="line">services.AddDbContextPool&lt;SeckillContext&gt;(options =&gt; &#123;</span><br><span class="line">    options.UseMySql(Configuration.GetConnectionString(&quot;DefaultConnection&quot;),</span><br><span class="line">        new MySqlServerVersion(&quot;5.7.22&quot;), o =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            o.MinBatchSize(1); // 更新批处理操作最小个数</span><br><span class="line">            o.MaxBatchSize(100); //更新批处理操作最大个数</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>大容量更新</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">     #region 11、大容量更新</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、默认批处理10万条。</span><br><span class="line">        foreach (var seckill in SeckillContext.Seckills)</span><br><span class="line">        &#123;</span><br><span class="line">            seckill.SeckillName = &quot;Tony&quot;; // 批量一个一个更新</span><br><span class="line">        &#125;</span><br><span class="line">        SeckillContext.SaveChanges();</span><br><span class="line"></span><br><span class="line">        // 2、直接sql处理（减少客户端数据）</span><br><span class="line">        SeckillContext.Seckills.FromSqlRaw(&quot;UPDATE [Seckills] SET [SeckillName] = &#x27;Tony&#x27;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DbContext连接池</p>
</li>
<li><p>在 Startup 类的 ConfigService 方法里面添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">            services.AddDbContextPool&lt;BloggingContext&gt;(</span><br><span class="line">options =&gt; options.UseSqlServer(connectionString));</span><br></pre></td></tr></table></figure>
</li>
<li><p>多使用参数化查询，使用复用语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">    // 高级性能主题 </span><br><span class="line">    #region 13、查询缓存和参数化(预编译) 编译预先的sql。复用sql语句，提升性能目的</span><br><span class="line">    &#123;</span><br><span class="line">        // 1、固定值查询（生成2条sql）直接生成sql</span><br><span class="line">        var seckill1 = SeckillContext.Seckills.FirstOrDefault(p =&gt; p.SeckillName == &quot;iPhone 13&quot;);</span><br><span class="line">        var seckill2 = SeckillContext.Seckills.FirstOrDefault(p =&gt; p.SeckillName == &quot;123123&quot;);</span><br><span class="line"></span><br><span class="line">        // 2、参数化查询（生成一条sql）原理 ：sql参数缓存</span><br><span class="line">        var SeckillName = &quot;iPhone 13&quot;;</span><br><span class="line">        var seckill3 = SeckillContext.Seckills.FirstOrDefault(p =&gt; p.SeckillName == SeckillName);</span><br><span class="line">        SeckillName = &quot;123123&quot;;</span><br><span class="line">        var seckill4 = SeckillContext.Seckills.FirstOrDefault(p =&gt; p.SeckillName == SeckillName);</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用动态拼接查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查询秒杀商品接口</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public IEnumerable&lt;Seckill&gt; GetSeckills()</span><br><span class="line">&#123;</span><br><span class="line">     // 查询商品：商品名称，商品价格，商品ID</span><br><span class="line">    #region 14、动态拼接查询</span><br><span class="line">    &#123;</span><br><span class="line">        IQueryable&lt;Seckill&gt; seckills = SeckillContext.Seckills;</span><br><span class="line"></span><br><span class="line">        if (seckill.SeckillName != null &amp;&amp; seckill.SeckillName.Length &gt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            seckills = seckills.Where(b =&gt; b.SeckillName == seckill.SeckillName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/BlogPro/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/BlogPro/">1</a><span class="space">&hellip;</span><a class="page-number" href="/BlogPro/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/BlogPro/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/BlogPro/page/13/">13</a><a class="extend next" rel="next" href="/BlogPro/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="John Doe"
      src="/BlogPro/images/Wx.jpg">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description">这里是何锦祥的博客，记录生活点滴，分享思考与感悟。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/BlogPro/archives/">
        
          <span class="site-state-item-count">121</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/BlogPro/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/SMDegz" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;SMDegz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/BlogPro/1522107010@qq.com" title="E-Mail → 1522107010@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/%E4%B8%8D%E4%BC%9A%E7%BC%96%E7%A8%8B%E7%9A%84%E7%8C%AB" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;不会编程的猫" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://smdegz.github.io/BlogPro/" title="https:&#x2F;&#x2F;smdegz.github.io&#x2F;BlogPro&#x2F;">smdegz Blog</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/BlogPro/lib/anime.min.js"></script>
  <script src="/BlogPro/lib/velocity/velocity.min.js"></script>
  <script src="/BlogPro/lib/velocity/velocity.ui.min.js"></script>

<script src="/BlogPro/js/utils.js"></script>

<script src="/BlogPro/js/motion.js"></script>


<script src="/BlogPro/js/schemes/pisces.js"></script>


<script src="/BlogPro/js/next-boot.js"></script>


  <script defer src="/BlogPro/lib/three/three.min.js"></script>
    <script defer src="/BlogPro/lib/three/canvas_sphere.min.js"></script>


  




  
<script src="/BlogPro/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'i6ML4c6D9phSdR4vRG7tjH8M-gzGzoHsz',
      appKey     : 'BfRJ9pJSV3u0CAuvm1xEwNL8',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
